---
title: "Kids PM Summary"
author: "Ethan Walker"
date: "Started 22 Nov 2019, Updated 13 Dec 2019"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE)
```

```{r, message=FALSE}
library(tidyverse)
library(readr)
library(knitr)
library(lubridate)
jvPalette <- c("#330099","#CC0066","#FF6633", 
                 "#0099CC", "#FF9900","#CC6633",
                  "#FF3366", "#33CC99", "#33999")
```

```{r}
# Load data
kids_pm <- read_rds("Output/kids_pm_new.rds")
```

# Summary stats
## Updated as data is cleaned
```{r}
# summary by area
summary_area <- kids_pm %>%
  # filtering out specific houses during data cleaning
  ## decide for sure if they should be exluded going forward
  mutate(do_not_use = if_else(area == "AK" & home_winter_id == "39", 1, 0),
         do_not_use = if_else(area == "AK" & home_winter_id == "89", 1, do_not_use),
         do_not_use = if_else(area == "NN" & home_winter_id == "127", 1, do_not_use),
         do_not_use = if_else(area == "NN" & home_winter_id == "1330", 1, do_not_use),
         do_not_use = if_else(area == "NN" & home_winter_id == "134", 1, do_not_use),
         do_not_use = if_else(area == "NN" & home_winter_id == "135", 1, do_not_use),
         do_not_use = if_else(area == "NN" & home_winter_id == "1510", 1, do_not_use),
         do_not_use = if_else(area == "NN" & home_winter_id == "161", 1, do_not_use),
         do_not_use = if_else(area == "NN" & home_winter_id == "165", 1, do_not_use),
         do_not_use = if_else(area == "NN" & home_winter_id == "2150", 1, do_not_use),
         do_not_use = if_else(area == "NN" & home_winter_id == "2210", 1, do_not_use),
         do_not_use = if_else(area == "NN" & home_winter_id == "29", 1, do_not_use),
         do_not_use = if_else(area == "NN" & home_winter_id == "58", 1, do_not_use),
         do_not_use = if_else(area == "NN" & home_winter_id == "620", 1, do_not_use),
         do_not_use = if_else(area == "NN" & home_winter_id == "840", 1, do_not_use),
         do_not_use = if_else(area == "NN" & home_winter_id == "86", 1, do_not_use),
         do_not_use = if_else(area == "WMT" & home_winter_id == "1910", 1, do_not_use),
         do_not_use = if_else(area == "WMT" & home_winter_id == "2500", 1, do_not_use),
         do_not_use = if_else(area == "WMT" & home_winter_id == "2510", 1, do_not_use),
         do_not_use = if_else(area == "WMT" & home_winter_id == "2860", 1, do_not_use),
         do_not_use = if_else(area == "WMT" & home_winter_id == "3750", 1, do_not_use),
         do_not_use = if_else(area == "WMT" & home_winter_id == "5100", 
                              1, do_not_use)) %>% 
  filter(do_not_use != 1) %>% 
  # filter out high PM values
  filter(pm < 5000) %>% 
  #filter(actual_vs_expected == 1) %>% 
  #filter(pm <0) %>% 
  group_by(area) %>% 
  # Run summary stats
  summarize("n" = n(),
            "Mean PM" = mean(pm, na.rm = TRUE), 
            "SD PM" = sd(pm, na.rm = TRUE),
            "Min PM" = min(pm, na.rm = TRUE), 
            "Median PM" = median(pm, na.rm = TRUE),
            "Max PM" = max(pm, na.rm = TRUE),
            "Mean Sample Days" = mean(pm_sample_interval, na.rm = TRUE),
            "Min Sample Days" = min(pm_sample_interval, na.rm = TRUE), 
            "Max Sample Days" = max(pm_sample_interval, na.rm = TRUE),
            "Mean Sample Obs" = mean(pm_total_observations, na.rm = TRUE),
            "Min Sample Obs" = min(pm_total_observations, na.rm = TRUE), 
            "Max Sample Obs" = max(pm_total_observations, na.rm = TRUE)) %>% 
  # transpose data for ease of reading
  t()
# create column names and make it look nicer
summary <- as.data.frame(summary_area)
my_names <- summary_area[1, ]
colnames(summary) <- my_names
summary_area <- summary %>% 
  rownames_to_column() %>% 
  rename(Statistic = rowname) %>% 
  filter(Statistic != "area") 
kable(summary_area, digits = 2)
```

# Summarize by ID and Dusttrak ID
```{r}
# summary by home_winter_id
summary_id <- kids_pm %>% 
  group_by(area, home_winter_id) %>% 
  summarise("n" = n(),
            "Mean PM" = mean(pm, na.rm = TRUE), 
            "SD PM" = sd(pm, na.rm = TRUE),
            "Min PM" = min(pm, na.rm = TRUE), 
            "Median PM" = median(pm, na.rm = TRUE),
            "Max PM" = max(pm, na.rm = TRUE),
            "Act vs Exp Diff" = first(as.numeric(actual_vs_expected_diff)),
            "Act vs Exp" = first(actual_vs_expected),
            "Comments" = first(qaqccomments))
# write_csv(summary_id, "output/kids_summary_id.csv")

# summary by dusttrak id
summary_dtid <- kids_pm %>% 
  group_by(dtid) %>% 
  summarise("n" = n(),
            "Mean PM" = mean(pm, na.rm = TRUE), 
            "SD PM" = sd(pm, na.rm = TRUE),
            "Min PM" = min(pm, na.rm = TRUE), 
            "Median PM" = median(pm, na.rm = TRUE),
            "Max PM" = max(pm, na.rm = TRUE))
```

# Histogram for distribution of PM by individual ID
```{r}
histogram_id <- kids_pm %>% 
  filter(home_winter_id == "10" & area == "AK") %>% 
  ggplot() + 
    geom_histogram(aes(pm), bins = 50) +
    theme_classic()
histogram_id
```

# Function to look at PM data across time
```{r}
# Plot PM by datetime to look at trends, gaps, and peaks
pm_time_plot_function <- function(id, location) {
pm_time_plot <- kids_pm %>% 
  filter(home_winter_id == id & area == location) %>% 
  #filter(pm < 30000) %>% 
  arrange(pm_datetime) %>% 
  mutate(pm_sampling_day = as.character(pm_sampling_day),
         day_of_week = factor(day_of_week,
                              levels = c("Sunday", "Monday", "Tuesday", "Wednesday", 
                                         "Thursday", "Friday", "Saturday"))) %>%
  ggplot() + 
    geom_point(aes(pm_datetime, pm, color = day_of_week), size = 1.5) +
    theme_classic() +
    labs(title = id,
         y = expression(paste("PM"[2.5], " (", mu, g/m^3, ")")),
         x = "Datetime",
         color = "Day of week") +
    theme(axis.title.y = element_text(size = 12,
                                      margin = margin(t = 0, r = 20, b = 0, l = 0)),
          axis.title.x = element_text(size = 12),
          axis.text.x = element_blank(),
          axis.text.y = element_text(size = 12, color = "black"),
          axis.line.x = element_line(colour = "black", size = 1), 
          axis.line.y = element_line(colour = "black", size = 1), 
          axis.ticks = element_blank()) +
    scale_color_manual(values = jvPalette)

gaps <<- kids_pm %>% 
  filter(home_winter_id == id & area == location) %>% 
  mutate(pm_datetime = ymd_hms(pm_datetime),
         datetime_lead = ymd_hms(lead(pm_datetime)),
         datetime_1 = seconds(pm_datetime),
         datetime_2 = seconds(datetime_lead),
         datetime_diff_minutes = as.numeric(datetime_2 - datetime_1)/60,
         datetime_diff_hours = as.numeric(datetime_diff_minutes/60)) %>% 
  arrange(desc(datetime_diff_minutes)) %>% 
  select(day_of_week, pm_sampling_day, datetime_diff_minutes, datetime_diff_hours, 
         pm_datetime, datetime_lead)

pm_desc <<- kids_pm %>% 
  filter(home_winter_id == id & area == location) %>% 
  arrange(desc(pm)) %>% 
  select(pm_datetime, pm, pm_sampling_day)

pm_time_plot
}
```

# Run function from above to look at results
```{r}
# Change function input to look at specific home
# Run all of these lines together
pm_time_plot_function(id = "85", location = "AK")
head(gaps, 25)
head(pm_desc, 25)
tail(pm_desc, 25)

# filter data for a single home
check_data <- kids_pm %>% 
  filter(area == "WMT" & home_winter_id == "513") %>% 
  filter(pm < 0)
```

# Boxplots for PM by study area
```{r, fig.height=6, fig.width=5}
boxplots_kids_pm <- kids_pm %>% 
  filter(pm < 500) %>% 
  ggplot(aes(area, pm)) +
    geom_boxplot(aes(size = 1), lwd = 1.2, colour = "black", 
               fatten = 1, outlier.size = 1.5, width = 0.35) +
    stat_summary(fun.y=mean, geom="point", shape=17, size=3, color="red") +
    theme_minimal() +
    ylim(-100, 500) +
    #geom_hline(yintercept = 50, color = "red", size = 1.2) +
    labs(y = expression(paste("PM"[2.5], " (", mu, g/m^3, ")"))) +
    #labs(aes(x = "", y = paste("48-hour indoor PM "[2.5], " (", mu, g/m^3, ")"))) +
    theme(axis.text.x = element_text(size = 16, colour = "black"),
          axis.text.y = element_text(size = 16, colour = "black"),
          axis.title.y = element_text(size = 16,
                                      margin = margin(t = 0, r = 20, b = 0, l = 0)),
          axis.title.x = element_blank(),
          axis.line.x = element_line(colour = "black", size = 1.2), 
          axis.line.y = element_line(colour = "black", size = 1.2), 
          axis.ticks = element_blank())
boxplots_kids_pm
```

