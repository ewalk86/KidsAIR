---
title: "KidsAIR: exposure model"
author: "Ethan Walker"
date: "Started 19 March 2020, Updated 16 April 2020"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE,
                      eval = TRUE, include = TRUE)
```

```{r, message=FALSE}
library(tidyverse)
library(readxl)
library(naniar)
library(lubridate)
library(zoo)
library(lme4)
library(lmerTest)
library(pbkrtest)
library(emmeans)
library(broom)
library(MuMIn)
library(leaps)
jv_palette <- c("#330099","#CC0066","#FF6633", 
                 "#0099CC", "#FF9900","#CC6633",
                  "#FF3366", "#33CC99", "#33999")
```

```{r}
# Load individual datasets

input_path <- c("C:/Users/ethan.walker/Box/Ethan Walker UM/R/KidsAIR/Input/")
output_path <- c("C:/Users/ethan.walker/Box/Ethan Walker UM/R/KidsAIR/")
input_file <- c("exposure_analysis_data_long_new.rds")
output_file <- c("exposure_analysis_data_long_new.rds")

exposure_analysis_data_long <- 
  read_rds(paste0(output_path, "Output/exposure_analysis_data_long_new.rds")) 

exposure_analysis_data_medium <- 
  read_rds(paste0(output_path, "Output/exposure_analysis_data_medium.rds")) 

exposure_analysis_data_short <- 
  read_rds(paste0(output_path, "Output/exposure_analysis_data_short.rds"))

sums_rolling_pm_data <- 
  read_rds(paste0(output_path, "Output/sums_rolling_pm_data.rds"))

health_exposure_data_sampling_day <- 
  read_rds(paste0(output_path, "Output/health_exposure_data_sampling_day.rds"))
```

```{r}
# Prep and merge data

####### Format SUMs data to merge with analysis data below
sums_temp_change <- sums_rolling_pm_data %>% 
  filter(winter_id == 1 & treatment == "Placebo") %>% 
  group_by(area, home, sampling_day) %>% 
  distinct(datetime_sums, .keep_all = TRUE) %>% 
  group_by(area, home, sampling_day) %>% 
  mutate(time_diff = (lead(datetime_sums) - datetime_sums)) %>% 
  mutate(lead_temp = if_else(time_diff < 20, lead(temp_c_sums, 4), lead(temp_c_sums)),
         lead_temp = if_else(time_diff > 25, 999, lead_temp)) %>% 
  replace_with_na(replace = list(lead_temp = 999)) %>% 
  mutate(temp_diff = lead_temp - temp_c_sums,
         # change temp in the following line
         temp_diff_check = if_else(temp_diff >= 5, 1, 0),
         heat_event = if_else(temp_diff_check == 1 & lag(temp_diff_check) == 1, 0,
                              temp_diff_check),
         heat_event = if_else(is.na(temp_diff_check), 1,
                              heat_event)) %>% 
  group_by(area, home, sampling_day) %>% 
  mutate(sums_events_sampling_day = sum(heat_event, na.rm = TRUE),
         sums_events_sampling_day_cat = cut(sums_events_sampling_day, 
                                            breaks = c(0, 2, 50),
                           labels = c("<2", "2+"),
                                 right = FALSE)) %>% 
  distinct(sampling_day, .keep_all = TRUE) %>% 
  ungroup() %>% 
  select(area:pm_rolling_20, sums_mean_winter:sums_mean_sampling_period,
         time_diff:sums_events_sampling_day_cat) %>% 
  arrange(area, home, sample_date) %>% 
  group_by(home) %>% 
  mutate(sums_events_sampling_period = mean(sums_events_sampling_day, na.rm = TRUE)) %>% 
  select(area, home, home_winter_id, sums_events_sampling_period) %>% 
  distinct(home, .keep_all = TRUE) %>% 
  ungroup()

####### Format ambient data to merge with analysis data below
ambient_data <- exposure_analysis_data_long %>% 
  filter(winter_id == 1 & treatment == "Placebo") %>% 
  #filter(area == "AK") %>% 
  filter(!is.na(sampling_day)) %>% 
  filter(!is.na(sample_date)) %>%
  select(area, home, child_id_char, sample_date, sampling_day, pm_mean_daily,
         zip:mean_temp_roll_4day) %>% 
  group_by(home) %>% 
  mutate(amb_pm_sampling_period_5 = mean(amb_pm_24hr, na.rm = TRUE)/5,
         mean_temp_sampling_period_5 = mean(mean_temp, na.rm = TRUE)/5) %>% 
  distinct(home, .keep_all = TRUE) %>% 
  ungroup()

####### Format home activity data to merge with analysis data below
home_activity_data <- exposure_analysis_data_medium %>% 
  filter(winter_id == 1 & treatment == "Placebo") %>% 
  group_by(area, home) %>% 
  distinct(sampling_day, .keep_all = TRUE) %>% 
  group_by(area, home) %>% 
  mutate_at(vars(starts_with("home_act")), as.numeric) %>% 
  mutate_at(vars(starts_with("home_act")), funs(. - 1)) %>% 
  mutate_at(vars(starts_with("home_act")), funs(sum(.))) %>% 
  ungroup() %>% 
  distinct(area, home, .keep_all = TRUE) %>% 
  select(home, area, sampling_day, starts_with("home_act"))

####### Format full data to use for analysis
analysis_data <- exposure_analysis_data_short %>% 
  filter(winter_id == 1 & treatment == "Placebo") %>% 
  group_by(area, home) %>% 
  distinct(home, .keep_all = TRUE) %>% 
  ungroup() %>% 
  mutate(moisture_closest_2level = cut(moisture_closest, breaks = c(0, 10.5, 100),
                                 labels = c("<10.5", "10.5+"),
                                 right = FALSE),
         moisture_winter_2level = cut(mean_moisture_winter, breaks = c(0, 10.5, 100),
                                 labels = c("<10.5", "10.5+"),
                                 right = FALSE)) %>% 
  mutate(temp_max_2level = cut(temp_indoor_max, breaks = c(0, 30, 100),
                                 labels = c("<30", "30+"),
                                 right = FALSE),
         temp_min_2level = cut(temp_indoor_min, breaks = c(0, 16.5, 100),
                                 labels = c("<16.5", "16.5+"),
                                 right = FALSE),
         rh_max_2level = cut(rh_indoor_max, breaks = c(0, 40, 100),
                                 labels = c("<40", "40+"),
                                 right = FALSE),
         rh_min_2level = cut(rh_indoor_min, breaks = c(0, 20, 100),
                                 labels = c("<20", "20+"),
                                 right = FALSE)) %>% 
  mutate(sums_mean_sampling_period_5 = sums_mean_sampling_period/5,
         temp_perc_25_2level = cut(temp_perc_25, breaks = c(0, 50, 100),
                                 labels = c("<50", "50+"),
                                 right = FALSE),
         temp_perc_27_2level = cut(temp_perc_27, breaks = c(0, 35, 100),
                                 labels = c("<35", "35+"),
                                 right = FALSE),
         temp_perc_30_2level = cut(temp_perc_30, breaks = c(0, 10, 100),
                                 labels = c("<10", "10+"),
                                 right = FALSE)) %>% 
  left_join(sums_temp_change, by = c("area", "home")) %>% 
  left_join(ambient_data, by = c("area", "home")) %>% 
  select(-starts_with("home_act")) %>% 
  left_join(home_activity_data, by = c("area", "home")) %>% 
  select(pm_mean_sampling_period, area, income_3level,  
                 residents_smoke, home_floors_2level, stove_age_3level,  
                 chimney_clean_3level, home_mold, wood_collect_2level, 
                 home_act_door, home_act_smoking, home_act_sweep,
                 stove_grade_3level) %>% 
  filter(!is.na(pm_mean_sampling_period)) %>% 
  na.exclude()
```

Initial variables to use for model selection (14) from collinearity RMD:
Demographics: area, income_3level, residents_smoke
Home Characteristics: home_floors_2level, stove_age_3level,
                      chimney_clean_3level, home_mold, wood_collect_2level
Home Activity: home_act_door, home_act_smoking, home_act_sweep
Others: sums_events_sampling_period, mean_temp_sampling_period_5, stove_grade_3level

Note: sums_events_sampling_period and mean_temp_sampling_period_5 have a lot of
missing data and reduce the sample size from 93 to 43. Not considering these
variables for model selection for now.

```{r, include=FALSE}
full_model <- lm(log(pm_mean_sampling_period) ~ area + income_3level + 
                 residents_smoke + home_floors_2level + stove_age_3level + 
                 chimney_clean_3level + home_mold + wood_collect_2level +
                 home_act_door + home_act_smoking + home_act_sweep + 
                 stove_grade_3level,
                 data = analysis_data)


summary(full_model)
r.squaredGLMM(full_model)
tidy(full_model)

plot(full_model)
```

# Best subsets selection using dredge() from MuMIn

Make sure to run `na.exclude` on analysis dataset and `options(na.action = "na.fail")`
before running the dredge best-subsets function below. This will ensure that the 
same dataset is being used for each potential model, which is an assumption and
a prerequisite for comparing different model ranking like AIC.

```{r, eval=FALSE, include=FALSE}
options(na.action = "na.fail")

all_subsets_aic <- dredge(full_model, rank = "AIC", extra = c("R^2"))
all_subsets_aicc <- dredge(full_model, rank = "AICc", extra = c("R^2"))
all_subsets_bic <- dredge(full_model, rank = "BIC", extra = c("R^2"))

write_rds(all_subsets_aic, paste0(output_path, "Output/all_subsets_aic"))
write_rds(all_subsets_aicc, paste0(output_path, "Output/all_subsets_aicc"))
write_rds(all_subsets_bic, paste0(output_path, "Output/all_subsets_bic"))
```

```{r}
all_subsets_aic <- read_rds(paste0(output_path, "Output/all_subsets_aic"))
all_subsets_aicc <- read_rds(paste0(output_path, "Output/all_subsets_aicc"))
all_subsets_bic <- read_rds(paste0(output_path, "Output/all_subsets_bic"))

head(all_subsets_aic, 10)
head(all_subsets_aicc, 10)
head(all_subsets_bic, 10)
```

```{r}
subset_model <- lm(log(pm_mean_sampling_period) ~ 
                   income_3level + home_act_door + residents_smoke, 
                   data = analysis_data)

summary(subset_model)
#tidy(subset_model)

plot(subset_model)
```

