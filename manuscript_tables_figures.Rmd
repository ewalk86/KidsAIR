---
title: 'KidsAIR: manuscript tables/figures'
author: "Ethan Walker"
date: "Started 13 May 2020, Updated 29 June 2020"
output:
  powerpoint_presentation: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, eval = TRUE, 
                      include = TRUE, warning = FALSE,
                      fig.height = 6, fig.width = 8)
```

```{r, message=FALSE}
library(tidyverse)
library(readxl)
library(naniar)
library(lubridate)
library(zoo)
library(knitr)
jv_palette <- c("#330099","#CC0066","#FF6633", 
                 "#0099CC", "#FF9900","#CC6633",
                  "#FF3366", "#33CC99", "#33999")
cbPalette <- c("#999999", "#E69F00", "#56B4E9", "#009E73", "#F0E442", 
               "#0072B2", "#D55E00", "#CC79A7")
```


```{r}
# Load individual datasets

file_path <- c("C:/Users/ethan.walker/Box/Ethan Walker UM/R/KidsAIR/")

health_exposure_data_sampling_day <- 
  read_rds(paste0(file_path, "Output/health_exposure_data_sampling_day.rds")) 

health_data_merged <- 
  read_rds(paste0(file_path, "Output/health_data_merged.rds")) 


kids_linked_ids <- read_rds(paste0(file_path, "Output/kids_linked_ids_final.rds")) 

demographics <- read_rds(paste0(file_path, "Output/demographics_final.rds")) 

exposure_analysis_data_long <- 
  read_rds(paste0(file_path, "Output/exposure_analysis_data_long_new.rds")) 

exposure_analysis_data_medium <- 
  read_rds(paste0(file_path, "Output/exposure_analysis_data_medium.rds")) 

exposure_analysis_data_short <- 
  read_rds(paste0(file_path, "Output/exposure_analysis_data_short.rds"))

sums_rolling_pm_data <- 
  read_rds(paste0(file_path, "Output/sums_rolling_pm_data.rds"))
```

# Count number of kids initially randomized
```{r}
file_path <- c("C:/Users/ethan.walker/Box/Ethan Walker UM/R/KidsAIR/")

ak_demographics <- read_rds(paste0(file_path, "Output/ak_demographic_data.rds"))
nn_demographics <- read_rds(paste0(file_path, "Output/nn_demographic_data.rds"))
wmt_demographics <- read_rds(paste0(file_path, "Output/wmt_demographic_data.rds"))

kids_demographics <- rbind(ak_demographics, nn_demographics, wmt_demographics) %>% 
  filter(!is.na(treatment)) %>% 
  filter(!is.na(child_id_num)) %>% 
  count(area, winter_id, treatment) %>% 
  filter(winter_id != 2)
```

# Count number of households initially randomized
```{r}
file_path <- c("C:/Users/ethan.walker/Box/Ethan Walker UM/R/KidsAIR/")

ak_ids <- read_rds(paste0(file_path, "Output/ak_ids_linked.rds"))
nn_ids <- read_rds(paste0(file_path, "Output/nn_ids_linked.rds"))
wmt_ids <- read_rds(paste0(file_path, "Output/wmt_ids_linked.rds"))

kids_ids <- rbind(ak_ids, nn_ids, wmt_ids) %>% 
  filter(!is.na(treatment)) %>% 
  ### WMA222 and WMA 233 had a treatment but no kids - not counting in flow chart
  filter(home != "WMA222" & home != "WMA233") %>%
  count(area, winter_id, treatment) %>% 
  filter(winter_id != 2)
```

# Count number of households and kids that participated by area and winter
```{r}
# number of households, total and by area
study_homes <- health_exposure_data_sampling_day %>% 
  distinct(home, winter_id, .keep_all = TRUE) %>%
  count(area, winter_id, treatment_assigned)


study_kids <- health_exposure_data_sampling_day %>% 
  select(area, home, child_id_char, child_id_num, winter_id, treatment_assigned) %>% 
  filter(!is.na(child_id_char)) %>% 
  distinct(area, child_id_num, winter_id, .keep_all = TRUE) %>% 
  count(area, winter_id, treatment_assigned)
```


```{r}
# add new vars to dataset
checkdata <- health_exposure_data_sampling_day %>% 
  select(area, home, residents_under_five)
```

```{r}
# summary data for manuscript tables
char_funct_total <- function(var, data = health_exposure_data_sampling_day){

demographics_summary <- data %>% 
  rename(new_var = var) %>% 
  filter(winter_id == 1) %>% 
  filter(treatment == "Placebo") %>%
  filter(home != "WMA300") %>% 
  arrange(new_var) %>% 
  distinct(home, .keep_all = TRUE) %>% 
  mutate(total_n = n()) %>% 
  group_by(area) %>% 
  mutate(area_n = n()) %>% 
  group_by(new_var) %>% 
  mutate(n = n(),
         percent = n()/total_n) %>% 
  distinct(new_var, .keep_all = TRUE) %>% 
  select(new_var, n, percent)
demographics_summary
}

char_funct_area <- function(var, data = health_exposure_data_sampling_day){

demographics_summary <- data %>% 
  rename(new_var = var) %>% 
  filter(winter_id == 1) %>% 
  filter(treatment == "Placebo") %>% 
  filter(home != "WMA300") %>% 
  arrange(new_var) %>% 
  distinct(home, .keep_all = TRUE) %>% 
  mutate(total_n = n()) %>% 
  group_by(area) %>% 
  mutate(area_n = n()) %>% 
  group_by(area, new_var) %>% 
  mutate(n = n(),
         percent = n()/area_n) %>% 
  distinct(new_var, .keep_all = TRUE) %>% 
  select(new_var, n, percent) %>% 
  arrange(area, new_var)
demographics_summary
}



char_funct_total("gender_parent")
char_funct_area("gender_parent")
char_funct_total("hispanic_parent")
char_funct_area("hispanic_parent")
char_funct_total("race_parent")
char_funct_area("race_parent")
char_funct_total("education_3level")
char_funct_area("education_3level")
char_funct_total("income_3level")
char_funct_area("income_3level")
char_funct_total("home_floors_2level")
char_funct_area("home_floors_2level")
char_funct_total("home_year_built_2level")
char_funct_area("home_year_built_2level")
char_funct_total("home_pets_2level")
char_funct_area("home_pets_2level")
char_funct_total("stove_age_3level")
char_funct_area("stove_age_3level")
char_funct_total("chimney_clean_3level")
char_funct_area("chimney_clean_3level")
char_funct_total("wood_collect_method_2level")
char_funct_area("wood_collect_method_2level")
char_funct_total("wood_collect_2level")
char_funct_area("wood_collect_2level")
char_funct_total("stove_grade_3level")
char_funct_area("stove_grade_3level")
```


```{r}
# summary data for manuscript tables
num_funct_total <- function(var, data = health_exposure_data_sampling_day){

demographics_summary <- data %>% 
  rename(new_var = var) %>% 
  mutate(new_var = as.numeric(new_var)) %>% 
  #mutate(new_var = (as.numeric(new_var)-32)*5/9) %>% 
  filter(winter_id == 1) %>% 
  filter(treatment == "Placebo") %>% 
  filter(home != "WMA300") %>% 
  arrange(new_var) %>% 
  distinct(home, .keep_all = TRUE) %>% 
  filter(!is.na(new_var)) %>% 
  select(area, home, new_var) %>% 
  summarize(mean_var = mean(new_var), sd_var = sd(new_var), n_var = n(), 
            min_var = min(new_var), med_var = median(new_var), max_var = max(new_var))
demographics_summary
}

num_funct_area <- function(var, data = health_exposure_data_sampling_day){

demographics_summary <- data %>% 
  rename(new_var = var) %>%
  mutate(new_var = as.numeric(new_var)) %>% 
  #mutate(new_var = (as.numeric(new_var)-32)*5/9) %>%
  filter(winter_id == 1) %>% 
  filter(treatment == "Placebo") %>% 
  filter(home != "WMA300") %>% 
  arrange(new_var) %>% 
  distinct(home, .keep_all = TRUE) %>% 
  filter(!is.na(new_var)) %>% 
  select(area, home, new_var) %>% 
  group_by(area) %>% 
  summarize(mean_var = mean(new_var), sd_var = sd(new_var), n_var = n(), 
            min_var = min(new_var), med_var = median(new_var), max_var = max(new_var))
demographics_summary
}


num_funct_total("residents_under_five")
num_funct_area("residents_under_five")
num_funct_total("home_bedrooms")
num_funct_area("home_bedrooms")
num_funct_total("pm_mean_sampling_period")
num_funct_area("pm_mean_sampling_period")
num_funct_total("pm_sample_interval")
num_funct_area("pm_sample_interval")
num_funct_total("moisture_closest")
num_funct_area("moisture_closest")
num_funct_total("temp_indoor_max")
num_funct_area("temp_indoor_max")
num_funct_total("rh_indoor_max")
num_funct_area("rh_indoor_max")
num_funct_total("mean_temp")
num_funct_area("mean_temp")
num_funct_total("amb_pm_24hr")
num_funct_area("amb_pm_24hr")
```


```{r}
other_vars_total <- exposure_analysis_data_short %>% 
  rename(new_var = sums_events_sampling_period) %>% 
  mutate(new_var = as.numeric(new_var)) %>% 
  filter(winter_id == 1) %>% 
  filter(treatment == "Placebo") %>% 
  filter(home != "WMA300") %>% 
  arrange(new_var) %>% 
  distinct(home, .keep_all = TRUE) %>% 
  filter(!is.na(new_var)) %>% 
  select(area, home, new_var) %>% 
  summarize(mean_var = mean(new_var), sd_var = sd(new_var), n_var = n(), 
            min_var = min(new_var), med_var = median(new_var), max_var = max(new_var))
other_vars_total

other_vars_area <- exposure_analysis_data_short %>% 
  rename(new_var = sums_events_sampling_period) %>% 
  mutate(new_var = as.numeric(new_var)) %>% 
  filter(winter_id == 1) %>% 
  filter(treatment == "Placebo") %>% 
  filter(home != "WMA300") %>% 
  arrange(new_var) %>% 
  distinct(home, .keep_all = TRUE) %>% 
  filter(!is.na(new_var)) %>% 
  select(area, home, new_var) %>% 
  group_by(area) %>% 
  summarize(mean_var = mean(new_var), sd_var = sd(new_var), n_var = n(), 
            min_var = min(new_var), med_var = median(new_var), max_var = max(new_var))
other_vars_area
```

