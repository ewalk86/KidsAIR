---
title: "KidsAIR: placebo home exposure paper data cleaning"
author: "Ethan Walker"
date: "Started 21 Jan 2020, Updated 22 Jan 2020"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, message=FALSE}
library(tidyverse)
library(readxl)
library(naniar)
library(lubridate)
library(zoo)
```

# Load individual datasets
```{r}
pm_clean <- read_rds("Output/pm_clean.rds")
sums_clean <- read_rds("Output/sums_clean.rds")

kids_linked_ids <- read_rds("Output/kids_linked_ids.rds")
demographics_clean <- read_rds("Output/demographics_clean.rds")
moisture_clean <- read_rds("Output/moisture_clean.rds")
indoor_temp_rh_clean <- read_rds("Output/indoor_temp_rh_clean.rds")
stove_use_clean <- read_rds("Output/stove_use_clean.rds")
stove_grades_clean <- read_rds("Output/stove_grades_clean.rds")
home_char_clean <- read_rds("Output/home_char_clean.rds")
home_act_clean <- read_rds("Output/home_act_clean.rds")
```

# Filter winter 1 and placebo homes from PM dataset
## These homes will be the focus of the initial exposure abstract/paper
```{r}
# 93 Winter 1 placebo homes have PM data
pm_homes_placebo <- pm_clean %>% 
  filter(winter_id == 1) %>% 
  filter(treatment == "Placebo") %>% 
  group_by(area, home) %>% 
  mutate(initial_obs = if_else(pm_datetime_new == first_datetime_new, 1, 0)) %>% 
  filter(initial_obs == 1) %>% 
  mutate(pm_home = "true") %>% 
  select(area, home, home_winter_id, pm_home) %>% 
  ungroup() %>% 
  arrange(area, home)

# 88 Winter 1 education homes have PM data
pm_homes_education <- pm_clean %>% 
  filter(winter_id == 1) %>% 
  filter(treatment == "Education") %>% 
  group_by(area, home) %>% 
  mutate(initial_obs = if_else(pm_datetime_new == first_datetime_new, 1, 0)) %>% 
  filter(initial_obs == 1) %>% 
  mutate(pm_home = "true") %>% 
  select(area, home, home_winter_id, pm_home) %>% 
  ungroup() %>% 
  arrange(area, home)

# 86 Winter 1 filter homes have PM data
pm_homes_filter <- pm_clean %>% 
  filter(winter_id == 1) %>% 
  filter(treatment == "Filter") %>% 
  group_by(area, home) %>% 
  mutate(initial_obs = if_else(pm_datetime_new == first_datetime_new, 1, 0)) %>% 
  filter(initial_obs == 1) %>% 
  mutate(pm_home = "true") %>% 
  select(area, home, home_winter_id, pm_home) %>% 
  ungroup() %>% 
  arrange(area, home)
```


#### Join selected homes from above with other datasets and filter homes of interest ####

# PM data
## 93 placebo homes from Winter 1 have PM data
## 88 education homes from Winter 1 have PM data
## 86 filter homes from Winter 1 have PM data
## All data is accounted for; missing data is truly missing from data collection issues
```{r}
pm_filtered <- pm_clean %>% 
  left_join(pm_homes_placebo, by = c("area", "home")) %>% 
  filter(pm_home == "true") %>% 
  filter(winter_id == 1) %>% 
  filter(treatment == "Placebo") %>% 
  ungroup() %>% 
  arrange(area, home)
  
pm_obs <- pm_clean %>% 
  left_join(pm_homes_placebo, by = c("area", "home")) %>% 
  filter(pm_home == "true") %>% 
  filter(winter_id == 1) %>% 
  group_by(area, home) %>% 
  summarize(n())
```

# SUMs data
## 80/93 placebo homes from Winter 1 have SUMs data
## 77/88 education homes from Winter 1 have SUMs data
## 70/86 filter homes from Winter 1 have SUMs data
## All data is accounted for; missing data is truly missing from data collection issues
```{r}
sums_filtered <- sums_clean %>% 
  # change to correct joining data of interest
  left_join(pm_homes_filter, by = c("area", "home")) %>% 
  filter(pm_home == "true") %>% 
  filter(winter_id == 1) %>% 
  #group_by(area, home) %>% 
  #summarize(n())
  ungroup() %>% 
  arrange(area, home)
```


# Demographics data
## 93/93 placebo homes from Winter 1 have demographic data
## 88/88 education homes from Winter 1 have demographic data
## 86/86 filter homes from Winter 1 have demographic data
```{r}
demographics_check1 <- demographics_clean %>% 
  # change to correct joining data of interest
  left_join(pm_homes_filter, by = c("area", "home")) %>% 
  filter(pm_home == "true") %>% 
  filter(winter_id == 1) %>% 
  group_by(area, home) %>% 
  summarize(n()) 


demographics_check2 <- demographics_clean %>% 
  # change to correct joining data of interest
  left_join(pm_homes_filter, by = c("area", "home")) %>% 
  filter(pm_home == "true") %>% 
  filter(winter_id == 1) %>% 
  group_by(area, home) %>% 
  summarize(n()) %>% 
  mutate(dem_filtered = "true") %>% 
  # change to correct joining data of interest
  full_join(pm_homes_filter, by = c("area", "home"))
  

demographics_filtered <- demographics_clean %>% 
  # change to correct joining data of interest
  left_join(pm_homes_filter, by = c("area", "home")) %>% 
  filter(pm_home == "true") %>% 
  filter(winter_id == 1) %>% 
  ungroup() %>% 
  arrange(area, home)
```


# Moisture data
## 60 placebo homes from Winter 1 have moisture data
#### Look for missing files/data? ####
```{r}
moisture_filtered <- moisture_clean %>% 
  left_join(pm_homes, by = c("area", "home")) %>% 
  filter(select_home == "select") %>% 
  filter(winter_id == 1) %>% 
  #group_by(area, home) %>% 
  #summarize(n())
  ungroup() %>% 
  arrange(area, home)
```


# Indoor temp/rh data
## 93 placebo homes from Winter 1 have indoor temp/rh data
#### Check for missing data ####
```{r}
indoor_temp_rh_filtered <- indoor_temp_rh_clean %>% 
  left_join(pm_homes, by = c("area", "home")) %>% 
  filter(select_home == "select") %>% 
  filter(winter_id == 1) %>% 
  #group_by(area, home) %>% 
  #summarize(n())
  ungroup() %>% 
  arrange(area, home)
```
  
  
# Stove use data
## 93 placebo homes from Winter 1 have stove use data
#### Check for missing data ####
```{r}
stove_use_filtered <- stove_use_clean %>% 
  left_join(pm_homes, by = c("area", "home")) %>% 
  filter(select_home == "select") %>% 
  filter(winter_id == 1) %>% 
  #group_by(area, home) %>% 
  #summarize(n())
  ungroup() %>% 
  arrange(area, home)
```


# Stove grades data
## 93 placebo homes from Winter 1 have stove grades data
#### Check for missing grades ####
```{r}
stove_grades_filtered <- stove_grades_clean %>% 
  left_join(pm_homes, by = c("area", "home")) %>% 
  filter(select_home == "select") %>% 
  filter(winter_id == 1) %>% 
  #group_by(area, home, stove_grade) %>% 
  #summarize(n())
  ungroup() %>% 
  arrange(area, home)
```


# Home characteristics data
## 93 placebo homes from Winter 1 have home characteristics data
#### Continue cleaning up data ####
```{r}
home_char_filtered <- home_char_clean %>% 
  left_join(pm_homes, by = c("area", "home")) %>% 
  filter(select_home == "select") %>% 
  filter(winter_id == 1) %>% 
  #group_by(area, home) %>% 
  #summarize(n())
  ungroup() %>% 
  arrange(area, home)
```


# Home activity data
## 93 placebo homes from Winter 1 have home activity data
#### Continue cleaning up data; make sure there are 6 obs per home ####
```{r}
home_act_filtered <- home_act_clean %>% 
  left_join(pm_homes, by = c("area", "home")) %>% 
  filter(select_home == "select") %>% 
  filter(winter_id == 1) %>% 
  #group_by(area, home) %>% 
  #summarize(n())
  ungroup() %>% 
  arrange(area, home)
```


