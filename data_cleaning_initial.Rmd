---
title: "KidsAIR initial data work"
author: "Ethan Walker"
date: "Started 19 Nov 2019"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, message=FALSE}
library(tidyverse)
library(readxl)
library(naniar)
library(lubridate)
library(zoo)
```

# Load, format, and save KidsAIR Dusttrack data
```{r}
# Load Dusttrack data
## List sheets within the excel file
list_sheets_nm <- excel_sheets("Input/nm_kids_dusttrack_20191121.xlsx")
## Apply the read_xlsx function to each item in the sheet list
## Bind the items from each sheet into a single dataframe
pm_initial_nm <- data.frame(do.call("rbind", lapply(list_sheets_nm, read_xlsx, 
                                      path = "Input/nm_kids_dusttrack_20191121.xlsx"))) %>% 
  mutate(area = "NM")

list_sheets_wmt <- excel_sheets("Input/wmt_kids_dusttrack_20191121.xlsx")
pm_initial_wmt <- data.frame(do.call("rbind", lapply(list_sheets_wmt, read_xlsx, 
                                      path = "Input/wmt_kids_dusttrack_20191121.xlsx"))) %>% 
  mutate(area = "WMT")

# Bind data together from different study areas
pm_initial <- rbind(pm_initial_nm, pm_initial_wmt)

# Rename and create new variables
kids_pm <- pm_initial %>% 
  # separate time from incorrect/associated date
  separate(time, into = c("trash", "time"), sep = " ") %>% 
  # format/rename variables
  mutate(id_home = as.factor(homeid),
         pm_date = ymd(date),
         pm_time = hms(time),
         pm = as.numeric(aerosol)) %>% 
  # new datetime variable
  unite(pm_datetime, c("date", "time"), sep = " ", remove = FALSE) %>% 
  select(id_home, area, pm_date, pm_time, pm_datetime, pm) %>% 
  arrange(id_home, pm_date) %>% 
  group_by(id_home) %>% 
  # new variables summarizing pm2.5 within each id_home
  mutate(pm_total_observations = n(),
         pm_total_summed = sum(pm),
         min_datetime = first(pm_datetime),
         max_datetime = last(pm_datetime),
         min_datetime = ymd_hms(min_datetime),
         max_datetime = ymd_hms(max_datetime),
         diff_datetime = interval(min_datetime, max_datetime),
         pm_total_days = diff_datetime/86400,
         pm_24hr_mean = pm_total_summed/pm_total_days,
         pm_rolling_24hr = rollsum(pm, 1440, fill = "extend", align = "right"),
         obs = row_number(),
         sampling_day = if_else(obs < 1441, 1, 0),
         sampling_day = if_else(obs < 2881 & obs > 1440, 2, sampling_day),
         sampling_day = if_else(obs < 4321 & obs > 2880, 3, sampling_day),
         sampling_day = if_else(obs < 5761 & obs > 4320, 4, sampling_day),
         sampling_day = if_else(obs < 7201 & obs > 5760, 5, sampling_day),
         sampling_day = if_else(obs < 8641 & obs > 7200, 6, sampling_day),
         sampling_day = if_else(obs < 10081 & obs > 8640, 7, sampling_day),
         sampling_day = if_else(obs > 10080, 8, sampling_day)) %>%
  group_by(id_home, sampling_day) %>% 
  mutate(pm_24hr_daily = sum(pm),
         pm_24hr_daily_weighted = pm_24hr_daily*(1440/n()),
         pm_sampling_day = sampling_day) %>% 
  ungroup() %>% 
  select(-min_datetime, -max_datetime, -diff_datetime, -obs, -sampling_day) 

# Save pm dataset as RDS and CSV
write_rds(kids_pm, "Output/kids_pm.rds")
write_csv(kids_pm, "Output/kids_pm.csv")
```

# Load, format, and save fuel moisture content data
```{r}
moisture_initial_wmt <- read_xlsx("Input/wmt_kids_moisture_20191122.xlsx")

kids_moisture <- moisture_initial_wmt %>% 
  mutate(id = as.factor(ID), # ask about what these IDs are 
         id_home = as.factor(HomeWinterID),
         moisture_date = ymd(CompletedDate),
         moisture_1 = as.numeric(Moisture1),
         moisture_2 = as.numeric(Moisture2),
         moisture_3 = as.numeric(Moisture3),
         moisture_ave = as.numeric(MoistureAve),
         moisture_missing = as.character(WhatMissing),
         moisture_incomplete = as.factor(Incomplete),
         moisture_ignore_missing = as.factor(IgnoreMissingData),
         moisture_ignore_reason = as.character(IgnoreReason),
         moisture_tech = as.character(Technician),
         moisture_split = as.factor(Split),
         area = "WMT") %>% 
  replace_with_na(replace = list(moisture_1 = 0, moisture_2 = 0,
                                 moisture_3 = 0, moisture_ave = 0)) %>% 
  replace_with_na(replace = list(moisture_1 = -999, moisture_2 = -999,
                                 moisture_3 = -999)) %>% 
  gather("sample", "value", c("moisture_1":"moisture_3")) %>% 
  group_by(id_home, moisture_date) %>% 
  mutate(moisture_ave = mean(value, na.rm = TRUE)) %>% 
  ungroup() %>% 
  spread(sample, value) %>% 
  select(id, id_home, area, moisture_date, moisture_1, moisture_2, moisture_3, 
         moisture_ave, moisture_missing, moisture_incomplete, moisture_ignore_missing,
         moisture_ignore_reason, moisture_tech, moisture_split)
  
# Save pm dataset as RDS and CSV
write_rds(kids_moisture, "Output/kids_moisture.rds")
write_csv(kids_moisture, "Output/kids_moisture.csv")
```

