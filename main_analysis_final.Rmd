---
title: 'KidsAIR: Main analysis'
author: "Ethan Walker"
date: "Updated 23 Dec 2020"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, eval = TRUE, include = TRUE,
                      message = FALSE, warning = FALSE)
```

```{r}
library(readxl)
library(naniar)
library(lubridate)
library(emmeans)
library(broom)
library(broom.mixed)
library(zoo)
library(lme4)
library(lmerTest)
library(mctest)
library(tidyverse)
library(knitr)
library(kableExtra)
library(MASS)
library(faraway)
library(DHARMa)
```


```{r}
# Load analysis dataset

file_path <- c("C:/Users/ethan.walker/Box/Ethan Walker UM/R/KidsAIR/")

analysis_data <- read_rds(paste0(file_path, 
                                 "Output/kids_analysis_data_1obs_per_child.rds")) %>% 
  mutate(pm_mean_sampling_period_iqr = pm_mean_sampling_period/25,
         pm_at_home_sampling_period_iqr = pm_at_home_sampling_period/25,
         lrti_events_di_total = as.factor(lrti_events_di_total),
         person_time_at_risk_iqr = person_time_at_risk/20,
         child_age = factor(child_age, levels = c("< 1", "1+"))) 
  #filter(area == "WMT")
  #filter(gender == "Female")
  #filter(home_sqft_2level == "1500+")

analysis_data_outliers <- analysis_data %>% 
  #rownames_to_column() %>% 
  #mutate(filter_outliers = if_else(rowname %in% c(57), 1, 0)) %>% 
  mutate(log_person_time_at_risk = if_else(area == "AK" & child_id_num == 31, 2.33, log_person_time_at_risk)) %>% 
  mutate(person_time_at_risk = if_else(area == "AK" & child_id_num == 31, 72, person_time_at_risk),
         lrti_events_total = as.factor(lrti_events_total),
         lrti_events_di_total = as.factor(lrti_events_di_total),
         child_age = factor(child_age, levels = c("< 1", "1+"))) 
  
analysis_data_winter1 <- read_rds(paste0(file_path, 
                                 "Output/kids_analysis_data_2obs_per_child.rds")) %>% 
  mutate(pm_mean_sampling_period_iqr = pm_mean_sampling_period/25,
         pm_at_home_sampling_period_iqr = pm_at_home_sampling_period/25,
         lrti_events_di_winter = as.factor(lrti_events_di_winter),
         child_age = factor(child_age, levels = c("< 1", "1+"))) %>% 
  filter(person_time_at_risk_winter > 0) %>% 
  #filter(area == "WMT") %>% 
  filter(winter_id == 1)

analysis_data_winter2 <- read_rds(paste0(file_path, 
                                 "Output/kids_analysis_data_2obs_per_child.rds")) %>% 
  mutate(pm_mean_sampling_period_iqr = pm_mean_sampling_period/25,
         pm_at_home_sampling_period_iqr = pm_at_home_sampling_period/25,
         lrti_events_di_winter = as.factor(lrti_events_di_winter),
         child_age = factor(child_age, levels = c("< 1", "1+"))) %>% 
  filter(person_time_at_risk_winter > 0) %>% 
  filter(winter_id == 2)

analysis_data_noak <- read_rds(paste0(file_path, 
                                 "Output/kids_analysis_data_1obs_per_child.rds")) %>% 
  mutate(pm_mean_sampling_period_iqr = pm_mean_sampling_period/25,
         pm_at_home_sampling_period_iqr = pm_at_home_sampling_period/25,
         lrti_events_di_total = as.factor(lrti_events_di_total),
         person_time_at_risk_iqr = person_time_at_risk/20,
         child_age = factor(child_age, levels = c("< 1", "1+"))) %>% 
  filter(area != "AK")
```


# Intent-to-treat framework, LRTI outcome

```{r, echo=TRUE}
# Run primary model and print results
itt_results <- glmer(lrti_events_di_total ~ treatment_assigned + 
                     child_age + person_time_at_risk +
                     (1 | home:cohort:area),
                     data = analysis_data, family = binomial, nAGQ = 10,
                     control = glmerControl(optimizer = "bobyqa"))
#write_rds(itt_results, paste0(file_path, "Output/itt_results.rds"))

#table(model.frame(itt_results)$treatment_assigned)
#nobs(itt_results)
```


## Model summary and diagnostic plots
```{r}
summary(itt_results)
#tidy(itt_results, conf.int = T)
itt_res <- simulateResiduals(itt_results)
testDispersion(itt_res, alternative = "two.sided")
plot(itt_res, rank = FALSE, quantreg = TRUE)
```


```{r, eval=FALSE, include=FALSE, fig.width=8, fig.height=5}
# Effect modification/interaction analysis

int_function <- function(model_data, interaction_var) {
  
  new_model_data <- model_data %>% 
    rename(int_var = interaction_var)

# Run primary model and print results
itt_results_int <<- glmer(lrti_events_di_total ~ treatment_assigned*int_var + 
                          child_age + 
                          person_time_at_risk + (1 | cohort:area),
                          data = new_model_data, family = binomial, nAGQ = 10,
                          control = glmerControl(optimizer = "bobyqa"))
#write_rds(itt_results_int, paste0(file_path, "Output/itt_pm_results_int_age.rds"))
save_summary <<- summary(itt_results_int)

int_emmeans <- emmeans(itt_results_int, revpairwise ~ treatment_assigned | int_var)
#summary(int_emmeans, conf.int = TRUE)
save_contrasts_full <<- summary(int_emmeans)
save_contrasts <<- confint(int_emmeans$contrasts) %>% 
  mutate(estimate = round((exp(estimate)), digits = 2),
         conf.low = round((exp(asymp.LCL)), digits = 2),
         conf.high = round((exp(asymp.UCL)), digits = 2)) %>% 
  dplyr::select(contrast, int_var, estimate, conf.low, conf.high)
obs <<- table(model.frame(itt_results_int)$treatment_assigned)
n_table <<- table(new_model_data$int_var, new_model_data$treatment_assigned)
#save_results

plot_results <- save_contrasts %>% 
  ggplot(aes(group = contrast, shape = contrast)) +
  geom_point(aes(x=int_var, y=estimate), 
             position = position_dodge(width = 0.5), size = 4) +
  geom_errorbar(aes(x=int_var, ymin=conf.low, ymax=conf.high), 
             position = position_dodge(width = 0.5), size = 1.2, width = 0.5) +
  geom_hline(yintercept = 1) +
  theme_bw() +  
  ggtitle(label = "Interaction contrasts for ITT framework, LRTI outcome",
          subtitle = paste0("Interaction term = ", interaction_var)) +
  labs(y = "Odds of LRTI vs placebo") +
  labs(x = "", group = "", shape = "") +
  theme(title = element_text(size = 16), 
          axis.text.x = element_text(size = 16, colour = "black", angle = 45,
                                     hjust = 1, vjust = .8),
          axis.text.y = element_text(size = 16, colour = "black"),
          axis.title.y = element_text(size = 16,
                                      margin = margin(t = 0, r = 20, b = 0, l = 0)),
          axis.line.x = element_line(colour = "black", size = 1.2), 
          axis.line.y = element_line(colour = "black", size = 1.2), 
          axis.ticks = element_blank(), 
          panel.border = element_blank(), 
          panel.grid = element_blank(),
          legend.position = "top",
          legend.text = element_text(size = 14, colour = "black")) 

pm_summary_table <<- new_model_data %>% 
  filter(!is.na(int_var)) %>% 
  group_by(int_var, treatment_assigned) %>% 
  summarize("Mean PM" = mean(pm_mean_sampling_period, na.rm = TRUE),
            "n" = n(),
            "SD PM" = sd(pm_mean_sampling_period, na.rm = TRUE),
            "Min PM" = min(pm_mean_sampling_period, na.rm = TRUE),
            "Median PM" = median(pm_mean_sampling_period, na.rm = TRUE),
            "Max PM" = max(pm_mean_sampling_period, na.rm = TRUE))

lrti_summary_table <<- new_model_data %>% 
  filter(!is.na(int_var)) %>% 
  group_by(int_var, treatment_assigned) %>% 
  mutate(lrti_events_num = as.numeric(lrti_events_di_total),
         lrti_events_num = lrti_events_num - 1) %>%  
  summarize("Total LRTI" = sum(lrti_events_num, na.rm = TRUE),
            "Group %" = `Total LRTI`/n()*100)

plot_results 

}

int_function(analysis_data, "residents_smoke")
n_table
save_contrasts
pm_summary_table
lrti_summary_table
save_summary
save_contrasts_full

# Try child_age, gender, home_floors_2level, home_sqft_2level, residents_smoke
```


```{r, eval=FALSE, include=FALSE}
# Run and save model results

itt_winter1_results <- glmer(lrti_events_di_winter ~ treatment_assigned + 
                     child_age + person_time_at_risk_winter +
                     (1 | home:cohort:area),
                     data = analysis_data_winter1, family = binomial, nAGQ = 10)
write_rds(itt_winter1_results, paste0(file_path, "Output/itt_winter1_results.rds"))


itt_winter2_results <- glmer(lrti_events_di_winter ~ treatment_assigned + 
                     child_age + person_time_at_risk_winter +
                     (1 | home:cohort:area),
                     data = analysis_data_winter2, family = binomial, nAGQ = 10)
write_rds(itt_winter2_results, paste0(file_path, "Output/itt_winter2_results.rds"))


itt_filter_type_results <- glmer(lrti_events_di_total ~ treatment_filter_type + 
                     child_age + person_time_at_risk +
                     (1 | home:cohort:area),
                     data = analysis_data, family = binomial, nAGQ = 10)

summary(itt_filter_type_results)

tidy_results <- tidy(itt_winter1_results, conf.int = TRUE) %>% 
  mutate(group_filter = if_else(grepl("treatment", term), 1, 0)) %>% 
  filter(group_filter == 1) %>% 
  mutate(term = gsub("treatment_filter_type", "", term),
         model = "Filter type") %>% 
  mutate(estimate = round(exp(estimate), digits = 2),
         conf.low = round(exp(conf.low), digits = 2),
         conf.high = round(exp(conf.high), digits = 2)) %>% 
  dplyr::select(model, term, estimate, conf.low, conf.high)
tidy_results

table(model.frame(itt_winter1_results)$treatment_assigned)

analysis_check <- analysis_data %>% 
  mutate(pm_na = if_else(!is.na(pm_mean_sampling_period), "PM Yes", "PM Missing"))

save_table <- table(analysis_check$pm_na, analysis_check$lrti_events_di_total, analysis_check$treatment_filter_type)
save_table
ftable(save_table, 1)

write_rds(itt_filter_type_results, paste0(file_path, "Output/itt_filter_type_results.rds"))


itt_noak_results <- glmer(lrti_events_di_total ~ treatment_assigned + 
                     child_age + person_time_at_risk +
                     (1 | home:cohort:area),
                     data = analysis_data_noak, family = binomial, nAGQ = 10)
write_rds(itt_noak_results, paste0(file_path, "Output/itt_noak_results.rds"))


itt_income_results <- glmer(lrti_events_di_total ~ treatment_assigned + 
                     child_age + person_time_at_risk + income_3level + 
                     (1 | home:cohort:area),
                     data = analysis_data, family = binomial, nAGQ = 10)
write_rds(itt_income_results, paste0(file_path, "Output/itt_income_results.rds"))


itt_filter_comp_results <- glmer(lrti_events_di_total ~ filter_compliance + 
                     child_age + person_time_at_risk + 
                     (1 | home:cohort:area),
                     data = analysis_data, family = binomial, nAGQ = 10)
summary(itt_filter_comp_results)
write_rds(itt_filter_comp_results, paste0(file_path, "Output/itt_filter_comp_results.rds"))


itt_smoke_results <- glmer(lrti_events_di_total ~ treatment_assigned + 
                     child_age + person_time_at_risk + residents_smoke + 
                     (1 | home:cohort:area),
                     data = analysis_data, family = binomial, nAGQ = 10)
write_rds(itt_smoke_results, paste0(file_path, "Output/itt_smoke_results.rds"))


itt_burn_level_results <- glmer(lrti_events_di_total ~ treatment_assigned + 
                     child_age + person_time_at_risk + burn_level_3level + 
                     (1 | home:cohort:area),
                     data = analysis_data, family = binomial, nAGQ = 10)
write_rds(itt_burn_level_results, paste0(file_path, "Output/itt_burn_level_results.rds"))


itt_smoking_results <- glmer(lrti_events_di_total ~ treatment_assigned + 
                     child_age + person_time_at_risk + home_act_smoking_sum + 
                     (1 | home:cohort:area),
                     data = analysis_data, family = binomial, nAGQ = 10)
write_rds(itt_smoking_results, paste0(file_path, "Output/itt_smoking_results.rds"))


itt_windows_results <- glmer(lrti_events_di_total ~ treatment_assigned + 
                     child_age + person_time_at_risk + home_act_windows_sum + 
                     (1 | home:cohort:area),
                     data = analysis_data, family = binomial, nAGQ = 10)
write_rds(itt_windows_results, paste0(file_path, "Output/itt_windows_results.rds"))


itt_door_results <- glmer(lrti_events_di_total ~ treatment_assigned + 
                     child_age + person_time_at_risk + home_act_door_sum + 
                     (1 | home:cohort:area),
                     data = analysis_data, family = binomial, nAGQ = 10)
write_rds(itt_door_results, paste0(file_path, "Output/itt_door_results.rds"))


itt_sweep_results <- glmer(lrti_events_di_total ~ treatment_assigned + 
                     child_age + person_time_at_risk + home_act_sweep_sum + 
                     (1 | home:cohort:area),
                     data = analysis_data, family = binomial, nAGQ = 10)
write_rds(itt_sweep_results, paste0(file_path, "Output/itt_sweep_results.rds"))


itt_ambpm_results <- glmer(lrti_events_di_total ~ treatment_assigned + 
                     child_age + person_time_at_risk + amb_pm_lrti + 
                     (1 | home:cohort:area),
                     data = analysis_data, family = binomial, nAGQ = 10)
write_rds(itt_ambpm_results, paste0(file_path, "Output/itt_ambpm_results.rds"))


itt_ambtemp_results <- glmer(lrti_events_di_total ~ treatment_assigned + 
                     child_age + person_time_at_risk + amb_temp_lrti + 
                     (1 | home:cohort:area),
                     data = analysis_data, family = binomial, nAGQ = 10)
write_rds(itt_ambtemp_results, paste0(file_path, "Output/itt_ambtemp_results.rds"))


itt_home_results <- glmer(lrti_events_di_total ~ treatment_assigned + 
                     child_age + person_time_at_risk + 
                     (1 | cohort:area),
                     data = analysis_data, family = binomial, nAGQ = 10)
write_rds(itt_home_results, paste0(file_path, "Output/itt_home_results.rds"))


itt_outlier_results <- glmer(lrti_events_di_total ~ treatment_assigned + 
                     child_age + person_time_at_risk +  
                     (1 | home:cohort:area),
                     data = analysis_data_outliers, family = binomial, nAGQ = 10)
write_rds(itt_outlier_results, paste0(file_path, "Output/itt_outlier_results.rds")) 
```


```{r}
# Load results
itt_results <- read_rds(paste0(file_path, "Output/itt_results.rds"))
itt_winter1_results <- read_rds(paste0(file_path, "Output/itt_winter1_results.rds"))
itt_noak_results <- read_rds(paste0(file_path, "Output/itt_noak_results.rds"))
#itt_winter2_results <- read_rds(paste0(file_path, "Output/itt_winter2_results.rds"))
itt_income_results <- read_rds(paste0(file_path, "Output/itt_income_results.rds"))
#itt_filter_type_results <- read_rds(paste0(file_path, "Output/itt_filter_type_results.rds"))
#itt_filter_comp_results <- read_rds(paste0(file_path, "Output/itt_filter_comp_results.rds"))
itt_smoke_results <- read_rds(paste0(file_path, "Output/itt_smoke_results.rds"))
itt_burn_level_results <- read_rds(paste0(file_path, "Output/itt_burn_level_results.rds"))
itt_smoking_results <- read_rds(paste0(file_path, "Output/itt_smoking_results.rds"))
itt_windows_results <- read_rds(paste0(file_path, "Output/itt_windows_results.rds"))
itt_door_results <- read_rds(paste0(file_path, "Output/itt_door_results.rds"))
itt_sweep_results <- read_rds(paste0(file_path, "Output/itt_sweep_results.rds"))
itt_ambpm_results <- read_rds(paste0(file_path, "Output/itt_ambpm_results.rds"))
itt_ambtemp_results <- read_rds(paste0(file_path, "Output/itt_ambtemp_results.rds"))
#itt_home_results <- read_rds(paste0(file_path, "Output/itt_home_results.rds"))
itt_outlier_results <- read_rds(paste0(file_path, "Output/itt_outlier_results.rds"))


# Function to clean results
results_function <- function(model_results, model_name) {
  
tidy_results <- tidy(model_results, conf.int = TRUE) %>% 
  mutate(group_filter = if_else(grepl("treatment", term), 1, 0)) %>% 
  filter(group_filter == 1) %>% 
  mutate(term = gsub("treatment_assigned", "", term),
         model = model_name) %>% 
  mutate(estimate = round((exp(estimate)), digits = 2),
         conf.low = round((exp(conf.low)), digits = 2),
         conf.high = round((exp(conf.high)), digits = 2)) %>% 
  dplyr::select(model, term, estimate, p.value, conf.low, conf.high)
tidy_results

}


# Run results through function, save, combine for plotting
itt_tidy <- results_function(itt_results, "ITT Primary")
itt_winter1_tidy <- results_function(itt_winter1_results, "ITT Winter 1")
itt_noak_tidy <- results_function(itt_noak_results, "ITT no AK")
#itt_winter2_tidy <- results_function(itt_winter2_results, "ITT Winter 2")
itt_income_tidy <- results_function(itt_income_results, "ITT + income")
#itt_filter_type_tidy <- results_function(itt_filter_type_results, "ITT + filt type")
#itt_filter_comp_tidy <- results_function(itt_filter_comp_results, "ITT + filt comp")
itt_smoke_tidy <- results_function(itt_smoke_results, "ITT + smoke hx")
itt_burn_level_tidy <- results_function(itt_burn_level_results, "ITT + burn level")
itt_smoking_tidy <- results_function(itt_smoking_results, "ITT + smoke act")
itt_windows_tidy <- results_function(itt_windows_results, "ITT + window act")
itt_door_tidy <- results_function(itt_door_results, "ITT + door act")
itt_sweep_tidy <- results_function(itt_sweep_results, "ITT + sweep act")
itt_ambpm_tidy <- results_function(itt_ambpm_results, "ITT + amb PM")
itt_ambtemp_tidy <- results_function(itt_ambtemp_results, "ITT + amb temp")
#itt_home_tidy <- results_function(itt_home_results, "ITT - home")
itt_outlier_tidy <- results_function(itt_outlier_results, "ITT outlier")


# Combine cleaned results
itt_results_combined <- rbind(itt_tidy, itt_winter1_tidy, itt_noak_tidy,
                              itt_income_tidy, 
                              itt_smoke_tidy, itt_burn_level_tidy, itt_smoking_tidy,
                              itt_windows_tidy, itt_door_tidy, itt_sweep_tidy,
                              itt_ambpm_tidy, itt_ambtemp_tidy,
                              itt_outlier_tidy)


# Plot results
itt_plot_estimates <- itt_results_combined %>%
  mutate(model = factor(model,
                        levels = c("ITT Primary", "ITT Winter 1", "ITT no AK",
                                   "ITT + income", 
                                   "ITT + smoke hx", "ITT + burn level", "ITT + smoke act",
                                   "ITT + window act", "ITT + door act", "ITT + sweep act",
                                   "ITT + amb PM", "ITT + amb temp",
                                   "ITT outlier"))) %>% 
  ggplot(aes(group = term, shape = term)) +
  geom_point(aes(x=model, y=estimate), 
             position = position_dodge(width = 0.5), size = 4) +
  geom_errorbar(aes(x=model, ymin=conf.low, ymax=conf.high), 
             position = position_dodge(width = 0.5), size = 1.2, width = 0.5) +
  theme_bw() +  
  geom_hline(yintercept =  1) +
  ggtitle(label = "Results for ITT framework, LRTI outcome") +
  labs(y = "Odds of LRTI compared to placebo") +
  labs(x = "", group = "", shape = "") +
  theme(title = element_text(size = 16), 
          axis.text.x = element_text(size = 16, colour = "black", angle = 45,
                                     hjust = 1, vjust = .8),
          axis.text.y = element_text(size = 16, colour = "black"),
          axis.title.y = element_text(size = 16,
                                      margin = margin(t = 0, r = 20, b = 0, l = 0)),
          axis.line.x = element_line(colour = "black", size = 1.2), 
          axis.line.y = element_line(colour = "black", size = 1.2), 
          axis.ticks = element_blank(), 
          panel.border = element_blank(), 
          panel.grid = element_blank(),
          legend.position = "top",
          legend.text = element_text(size = 14, colour = "black")) 
itt_plot_estimates


# Save plot as jpg
#ggsave("itt_plot_estimates.jpg", width = 12, height = 6)
```

ITT Primary = Logistic regression mixed model, as specified above  
ITT Winter 1 = Primary model with Winter 1 data only  
ITT no AK = Primary model without homes from AK (different placebo group)  
ITT + income = Primary model plus categorical income variable  
ITT + smoke hx = Primary model plus self-reported smoking variable  
ITT + burn level = Primary model plus self-reported burn-level compared to typical  
ITT + smoke act = Primary model plus # days during sampling with smoking  
ITT + window act = Primary model plus # days during sampling with windows open  
ITT + door act = Primary model plus # days during sampling with doors open  
ITT + sweep act = Primary model plus # days during sampling with sweeping/cleaning  
ITT + amb PM = Primary model plus amb PM during LRTI at-risk period  
ITT + amb temp = Primary model plus amb temp during LRTI at-risk period  
ITT outlier = Primary model with data that fixes incidence outlier  

## Analysis to assess effect modification

There were small differences in the associations across age groups (<1 vs >=1)  
and gender groups, but confidence intervals overlap substantially.  
There were minimal differences in associations across groups for levels/floors  
in the home, sqft of the home, or residents smoking.  

\pagebreak  

# Intent-to-treat framework, PM2.5 outcome

```{r, echo=TRUE}
# Run primary model and print results
itt_pm_results <- lmer(log(pm_mean_sampling_period) ~ treatment_assigned + 
                       (1 | cohort:area), data = analysis_data_winter1)
#write_rds(itt_pm_results, paste0(file_path, "Output/itt_pm_results.rds"))
# Adding the randomization variable for child_age leads to the exact same model results
# Adding a random term for home adversely impacts the model since there is only one
# distinct observation per home

#table(model.frame(itt_pm_results)$treatment_assigned)
#nobs(itt_pm_results)
```

## Model summary and diagnostic plots
```{r}
summary(itt_pm_results)
plot(itt_pm_results, main = "PM ITT Primary model", 
     xlab = "fitted values", ylab = "residuals")
qqnorm(residuals(itt_pm_results), main = "PM ITT Primary model")
qqline(residuals(itt_pm_results))
```


```{r, eval=FALSE, include=FALSE, fig.width=8, fig.height=5}
# Effect modification/interaction analysis

int_function <- function(model_data, interaction_var) {
  
  new_model_data <- model_data %>% 
    rename(int_var = interaction_var)

# Run primary model and print results
itt_pm_results_int <<- lmer(log(pm_mean_sampling_period) ~ treatment_assigned*int_var + 
                              child_age + 
                       (1 | cohort:area), data = new_model_data)
#write_rds(itt_pm_results_int, paste0(file_path, "Output/itt_pm_results_int_age.rds"))
save_summary <<- summary(itt_pm_results_int)

int_emmeans <- emmeans(itt_pm_results_int, revpairwise ~ treatment_assigned | int_var)
#summary(int_emmeans, conf.int = TRUE)
save_contrasts_full <<- summary(int_emmeans)
save_contrasts <<- confint(int_emmeans$contrasts) %>% 
  mutate(estimate = round((exp(estimate)-1)*100, digits = 2),
         conf.low = round((exp(lower.CL)-1)*100, digits = 2),
         conf.high = round((exp(upper.CL)-1)*100, digits = 2)) %>% 
  dplyr::select(contrast, int_var, estimate, conf.low, conf.high)
obs <<- table(model.frame(itt_pm_results_int)$treatment_assigned)
n_table <<- table(new_model_data$int_var, new_model_data$treatment_assigned)
#save_results

plot_results <- save_contrasts %>% 
  ggplot(aes(group = contrast, shape = contrast)) +
  geom_point(aes(x=int_var, y=estimate), 
             position = position_dodge(width = 0.5), size = 4) +
  geom_errorbar(aes(x=int_var, ymin=conf.low, ymax=conf.high), 
             position = position_dodge(width = 0.5), size = 1.2, width = 0.5) +
  geom_hline(yintercept = 0) +
  theme_bw() +  
  ggtitle(label = "Interaction contrasts for ITT framework, PM outcome",
          subtitle = paste0("Interaction term = ", interaction_var)) +
  labs(y = "% difference in PM2.5") +
  labs(x = "", group = "", shape = "") +
  theme(title = element_text(size = 16), 
          axis.text.x = element_text(size = 16, colour = "black", angle = 45,
                                     hjust = 1, vjust = .8),
          axis.text.y = element_text(size = 16, colour = "black"),
          axis.title.y = element_text(size = 16,
                                      margin = margin(t = 0, r = 20, b = 0, l = 0)),
          axis.line.x = element_line(colour = "black", size = 1.2), 
          axis.line.y = element_line(colour = "black", size = 1.2), 
          axis.ticks = element_blank(), 
          panel.border = element_blank(), 
          panel.grid = element_blank(),
          legend.position = "top",
          legend.text = element_text(size = 14, colour = "black")) 

pm_summary_table <<- new_model_data %>% 
  filter(!is.na(int_var)) %>% 
  group_by(int_var, treatment_assigned) %>% 
  summarize("Mean PM" = mean(pm_mean_sampling_period, na.rm = TRUE),
            "n" = n(),
            "SD PM" = sd(pm_mean_sampling_period, na.rm = TRUE),
            "Min PM" = min(pm_mean_sampling_period, na.rm = TRUE),
            "Median PM" = median(pm_mean_sampling_period, na.rm = TRUE),
            "Max PM" = max(pm_mean_sampling_period, na.rm = TRUE))

lrti_summary_table <<- new_model_data %>% 
  filter(!is.na(int_var)) %>% 
  group_by(int_var, treatment_assigned) %>% 
  mutate(lrti_events_num = as.numeric(lrti_events_di_winter),
         lrti_events_num = lrti_events_num - 1) %>%  
  summarize("Total LRTI" = sum(lrti_events_num, na.rm = TRUE),
            "Group %" = `Total LRTI`/n()*100)

plot_results 

}

int_function(analysis_data_winter1, "burn_level_3level")
n_table
save_contrasts
pm_summary_table
lrti_summary_table
save_summary
save_contrasts_full


# Try: home_floors_2level, home_sqft_2level, education_3level, child_age
# home_year_built_2level, stove_age_3level, stove_grade_3level, chimney_clean_3level,
# wood_collect_2level, wood_collect_method_2level, burn_level_3level, residents_smoke


#table(model.frame(itt_results_int)$treatment_assigned)
#((exp(-.418)-1)*100)
```



```{r, eval=FALSE, include=FALSE}
# Run and save model results 

itt_pm_noak_results <- glmer(log(pm_mean_sampling_period) ~ treatment_assigned + child_age + 
                       (1 | cohort:area), data = analysis_data_noak)
write_rds(itt_pm_noak_results, paste0(file_path, "Output/itt_pm_noak_results.rds"))

itt_pm_income_results <- glmer(log(pm_mean_sampling_period) ~ treatment_assigned + 
                               child_age + (1 | cohort:area) + 
                               income_3level, data = analysis_data_winter1)
write_rds(itt_pm_income_results, paste0(file_path, "Output/itt_pm_income_results.rds"))


itt_pm_filter_type_results <- glmer(log(pm_mean_sampling_period) ~ treatment_filter_type +
                                  child_age + (1 | cohort:area), data = analysis_data_winter1)
summary(itt_pm_filter_type_results)
tidy_results <- tidy(itt_pm_filter_type_results, conf.int = TRUE) %>% 
  mutate(group_filter = if_else(grepl("treatment", term), 1, 0)) %>% 
  filter(group_filter == 1) %>% 
  mutate(term = gsub("treatment_filter_type", "", term),
         model = "Filter type") %>% 
  mutate(estimate = round((exp(estimate)-1)*100, digits = 2),
         conf.low = round((exp(conf.low)-1)*100, digits = 2),
         conf.high = round((exp(conf.high)-1)*100, digits = 2)) %>% 
  dplyr::select(model, term, estimate, conf.low, conf.high)
tidy_results
table(model.frame(itt_pm_filter_type_results)$treatment_filter_type)
write_rds(itt_pm_filter_type_results, paste0(file_path, "Output/itt_pm_filter_type_results.rds"))
 

itt_pm_filter_comp_results <- glmer(log(pm_mean_sampling_period) ~ filter_compliance + 
                                  child_age + (1 | cohort:area), 
                                  data = analysis_data_winter1)
write_rds(itt_pm_filter_comp_results, paste0(file_path, "Output/itt_pm_filter_comp_results.rds"))


itt_pm_smoke_results <- glmer(log(pm_mean_sampling_period) ~ treatment_assigned + 
                              child_age + (1 | cohort:area) + 
                              residents_smoke, data = analysis_data_winter1)
write_rds(itt_pm_smoke_results, paste0(file_path, "Output/itt_pm_smoke_results.rds"))


itt_pm_burn_level_results <- glmer(log(pm_mean_sampling_period) ~ treatment_assigned + 
                                   child_age + (1 | cohort:area) + 
                                   burn_level_3level, data = analysis_data_winter1)
write_rds(itt_pm_burn_level_results, paste0(file_path, "Output/itt_pm_burn_level_results.rds"))


itt_pm_smoking_results <- glmer(log(pm_mean_sampling_period) ~ treatment_assigned + 
                                   child_age + (1 | cohort:area) + 
                                   home_act_smoking_sum, data = analysis_data_winter1)
write_rds(itt_pm_smoking_results, paste0(file_path, "Output/itt_pm_smoking_results.rds"))


itt_pm_windows_results <- glmer(log(pm_mean_sampling_period) ~ treatment_assigned + 
                                   child_age + (1 | cohort:area) + 
                                   home_act_windows_sum, data = analysis_data_winter1)
write_rds(itt_pm_windows_results, paste0(file_path, "Output/itt_pm_windows_results.rds"))


itt_pm_door_results <- glmer(log(pm_mean_sampling_period) ~ treatment_assigned + 
                                   child_age + (1 | cohort:area) + 
                                   home_act_door_sum, data = analysis_data_winter1)
write_rds(itt_pm_door_results, paste0(file_path, "Output/itt_pm_door_results.rds"))


itt_pm_sweep_results <- glmer(log(pm_mean_sampling_period) ~ treatment_assigned + 
                                   child_age + (1 | cohort:area) + 
                                   home_act_sweep_sum, data = analysis_data_winter1)
write_rds(itt_pm_sweep_results, paste0(file_path, "Output/itt_pm_sweep_results.rds"))


itt_pm_ambpm_results <- glmer(log(pm_mean_sampling_period) ~ treatment_assigned + 
                                   child_age + (1 | cohort:area) + 
                                   amb_pm_lrti, data = analysis_data_winter1)
write_rds(itt_pm_ambpm_results, paste0(file_path, "Output/itt_pm_ambpm_results.rds"))


itt_pm_ambtemp_results <- glmer(log(pm_mean_sampling_period) ~ treatment_assigned + 
                                   child_age + (1 | cohort:area) + 
                                   amb_temp_lrti, data = analysis_data_winter1)
write_rds(itt_pm_ambtemp_results, paste0(file_path, "Output/itt_pm_ambtemp_results.rds"))
```


```{r}
# Load results
itt_pm_results <- read_rds(paste0(file_path, "Output/itt_pm_results.rds"))
itt_pm_noak_results <- read_rds(paste0(file_path, "Output/itt_pm_noak_results.rds"))
itt_pm_income_results <- read_rds(paste0(file_path, "Output/itt_pm_income_results.rds"))
#itt_pm_filter_type_results <- read_rds(paste0(file_path, "Output/itt_pm_filter_type_results.rds"))
#itt_pm_filter_comp_results <- read_rds(paste0(file_path, "Output/itt_pm_filter_comp_results.rds"))
itt_pm_smoke_results <- read_rds(paste0(file_path, "Output/itt_pm_smoke_results.rds"))
itt_pm_burn_level_results <- read_rds(paste0(file_path, "Output/itt_pm_burn_level_results.rds"))
itt_pm_smoking_results <- read_rds(paste0(file_path, "Output/itt_pm_smoking_results.rds"))
itt_pm_windows_results <- read_rds(paste0(file_path, "Output/itt_pm_windows_results.rds"))
itt_pm_door_results <- read_rds(paste0(file_path, "Output/itt_pm_door_results.rds"))
itt_pm_sweep_results <- read_rds(paste0(file_path, "Output/itt_pm_sweep_results.rds"))
itt_pm_ambpm_results <- read_rds(paste0(file_path, "Output/itt_pm_ambpm_results.rds"))
itt_pm_ambtemp_results <- read_rds(paste0(file_path, "Output/itt_pm_ambtemp_results.rds"))


# Run function to clean results
results_function <- function(model_results, model_name) {
  
tidy_results <- tidy(model_results, conf.int = TRUE) %>% 
  mutate(group_filter = if_else(grepl("treatment", term), 1, 0)) %>% 
  filter(group_filter == 1) %>% 
  mutate(term = gsub("treatment_assigned", "", term),
         model = model_name) %>% 
  mutate(estimate = round((exp(estimate)-1)*100, digits = 2),
         conf.low = round((exp(conf.low)-1)*100, digits = 2),
         conf.high = round((exp(conf.high)-1)*100, digits = 2)) %>% 
  dplyr::select(model, term, estimate, conf.low, conf.high)
tidy_results

}


# Run results through function, save, combine for plotting
itt_pm_tidy <- results_function(itt_pm_results, "ITT Primary")
itt_pm_noak_tidy <- results_function(itt_pm_noak_results, "ITT no AK")
itt_pm_income_tidy <- results_function(itt_pm_income_results, "ITT + income")
#itt_pm_filter_type_tidy <- results_function(itt_pm_filter_type_results, "ITT filter type")
#itt_pm_filter_comp_tidy <- results_function(itt_pm_filter_comp_results, "ITT + filt comp")
itt_pm_smoke_tidy <- results_function(itt_pm_smoke_results, "ITT + smoke hx")
itt_pm_burn_level_tidy <- results_function(itt_pm_burn_level_results, "ITT + burn level")
itt_pm_smoking_tidy <- results_function(itt_pm_smoking_results, "ITT + smoke act")
itt_pm_windows_tidy <- results_function(itt_pm_windows_results, "ITT + window act")
itt_pm_door_tidy <- results_function(itt_pm_door_results, "ITT + door act")
itt_pm_sweep_tidy <- results_function(itt_pm_sweep_results, "ITT + sweep act")
itt_pm_ambpm_tidy <- results_function(itt_pm_ambpm_results, "ITT + amb PM")
itt_pm_ambtemp_tidy <- results_function(itt_pm_ambtemp_results, "ITT + amb temp")


# Combine cleaned results
itt_pm_results_combined <- rbind(itt_pm_tidy, itt_pm_noak_tidy, itt_pm_income_tidy, 
                              itt_pm_smoke_tidy, itt_pm_burn_level_tidy, itt_pm_smoking_tidy,
                              itt_pm_windows_tidy, itt_pm_door_tidy, itt_pm_sweep_tidy,
                              itt_pm_ambpm_tidy, itt_pm_ambtemp_tidy)


# Plot results
itt_pm_plot_estimates <- itt_pm_results_combined %>%
  mutate(model = factor(model,
                        levels = c("ITT Primary", "ITT no AK", "ITT + income", 
                                   "ITT + smoke hx", "ITT + burn level", "ITT + smoke act",
                                   "ITT + window act", "ITT + door act", "ITT + sweep act",
                                   "ITT + amb PM", "ITT + amb temp"))) %>% 
  ggplot(aes(group = term, shape = term)) +
  geom_point(aes(x=model, y=estimate), 
             position = position_dodge(width = 0.5), size = 4) +
  geom_errorbar(aes(x=model, ymin=conf.low, ymax=conf.high), 
             position = position_dodge(width = 0.5), size = 1.2, width = 0.5) +
  geom_hline(yintercept = 0) +
  theme_bw() +  
  ggtitle(label = "Results for ITT framework, PM outcome") +
  labs(y = "% difference in PM2.5 \n compared to placebo") +
  labs(x = "", group = "", shape = "") +
  theme(title = element_text(size = 16), 
          axis.text.x = element_text(size = 16, colour = "black", angle = 45,
                                     hjust = 1, vjust = .8),
          axis.text.y = element_text(size = 16, colour = "black"),
          axis.title.y = element_text(size = 16,
                                      margin = margin(t = 0, r = 20, b = 0, l = 0)),
          axis.line.x = element_line(colour = "black", size = 1.2), 
          axis.line.y = element_line(colour = "black", size = 1.2), 
          axis.ticks = element_blank(), 
          panel.border = element_blank(), 
          panel.grid = element_blank(),
          legend.position = "top",
          legend.text = element_text(size = 14, colour = "black")) 
itt_pm_plot_estimates


# Save plot as jpg
#ggsave("itt_pm_plot_estimates.jpg", width = 12, height = 6)
```

ITT Primary = Linear mixed model, as specified above  
ITT no AK = Primary model without homes from AK (different placebo group)  
ITT + income = Primary model plus categorical income variable  
ITT + smoke hx = Primary model plus self-reported smoking variable  
ITT + burn level = Primary model plus self-reported burn-level compared to typical  
ITT + smoke act = Primary model plus # days during sampling with smoking  
ITT + window act = Primary model plus # days during sampling with windows open  
ITT + door act = Primary model plus # days during sampling with doors open  
ITT + sweep act = Primary model plus # days during sampling with sweeping/cleaning  
ITT + amb PM = Primary model plus amb PM during LRTI at-risk period  
ITT + amb temp = Primary model plus amb temp during LRTI at-risk period  


## Analysis to assess effect modification

There were small differences in the associations across groups for levels/floors,    
age of home, when chimney was cleaned, and resident smoking status,  
but confidence intervals overlap substantially.  
There were minimal differences in associations across groups for other variables.    


\pagebreak  


# Exposure-response framework, LRTI outcome

```{r, echo=TRUE}
# Run primary model and print results
# The Neg Bin model was overfit; see isSingular() for further explanation

er_results <- glmer(lrti_events_di_winter ~ pm_mean_sampling_period_iqr + child_age + 
                          education_3level + residents_smoke + person_time_at_risk_winter +
                          (1 | home:cohort:area), 
                          data = analysis_data_winter1, family = binomial, nAGQ = 10,
                          control = glmerControl(optimizer = "bobyqa"))
#write_rds(er_results, paste0(file_path, "Output/er_results.rds"))

#nobs(er_results)
#isSingular(er_results)
```

## Model summary and diagnostic plots
```{r}
summary(er_results)
er_res <- simulateResiduals(er_results)
testDispersion(er_res, alternative = "two.sided")
plot(er_res, rank = TRUE, quantreg = TRUE)
```


```{r, eval=FALSE, include=FALSE, fig.width=8, fig.height=5}
# Effect modification/interaction analysis

int_function <- function(model_data, interaction_var) {
  
  new_model_data <- model_data %>% 
    rename(int_var = interaction_var)

# Run primary model and print results
er_results_int <<- glmer(lrti_events_di_winter ~ pm_mean_sampling_period_iqr*int_var + 
                          child_age + 
                          education_3level + 
                          #residents_smoke + 
                          person_time_at_risk_winter +
                          (1 | cohort:area), 
                          data = new_model_data, family = binomial, nAGQ = 10,
                          control = glmerControl(optimizer = "bobyqa"))
#write_rds(itt_pm_results_int, paste0(file_path, "Output/itt_pm_results_int_age.rds"))
save_summary <<- summary(er_results_int)

int_emtrends <- emtrends(er_results_int, pairwise ~ int_var, var = "pm_mean_sampling_period_iqr")

save_contrasts <<- confint(int_emtrends$emtrends) %>% 
  mutate(estimate = round(exp(pm_mean_sampling_period_iqr.trend), digits = 2),
         conf.low = round(exp(asymp.LCL), digits = 2),
         conf.high = round(exp(asymp.UCL), digits = 2)) %>% 
  dplyr::select(int_var, estimate, conf.low, conf.high)

plot_results <- save_contrasts %>% 
  ggplot() +
  geom_point(aes(x=int_var, y=estimate), 
             position = position_dodge(width = 0.5), size = 4) +
  geom_errorbar(aes(x=int_var, ymin=conf.low, ymax=conf.high), 
             position = position_dodge(width = 0.5), size = 1.2, width = 0.5) +
  geom_hline(yintercept = 1) +
  theme_bw() +  
  ggtitle(label = "Interaction contrasts for ER framework, LRTI outcome",
          subtitle = paste0("Interaction term = ", interaction_var)) +
  labs(y = "Odds of LRTI IQR increase in PM2.5") +
  labs(x = "", group = "", shape = "") +
  theme(title = element_text(size = 16), 
          axis.text.x = element_text(size = 16, colour = "black", angle = 45,
                                     hjust = 1, vjust = .8),
          axis.text.y = element_text(size = 16, colour = "black"),
          axis.title.y = element_text(size = 16,
                                      margin = margin(t = 0, r = 20, b = 0, l = 0)),
          axis.line.x = element_line(colour = "black", size = 1.2), 
          axis.line.y = element_line(colour = "black", size = 1.2), 
          axis.ticks = element_blank(), 
          panel.border = element_blank(), 
          panel.grid = element_blank(),
          legend.position = "top",
          legend.text = element_text(size = 14, colour = "black")) 

pm_summary_table <<- new_model_data %>% 
  filter(!is.na(int_var)) %>% 
  group_by(int_var) %>% 
  summarize("Mean PM" = mean(pm_mean_sampling_period, na.rm = TRUE),
            "n" = n(),
            "SD PM" = sd(pm_mean_sampling_period, na.rm = TRUE),
            "Min PM" = min(pm_mean_sampling_period, na.rm = TRUE),
            "Median PM" = median(pm_mean_sampling_period, na.rm = TRUE),
            "Max PM" = max(pm_mean_sampling_period, na.rm = TRUE))


lrti_summary_table <<- new_model_data %>% 
  filter(!is.na(int_var)) %>% 
  group_by(int_var) %>% 
  mutate(lrti_events_num = as.numeric(lrti_events_di_winter),
         lrti_events_num = lrti_events_num - 1) %>%  
  summarize("Total LRTI" = sum(lrti_events_num, na.rm = TRUE),
            "Group %" = `Total LRTI`/n()*100)


plot_results 

}

int_function(analysis_data_winter1, "residents_smoke")
save_contrasts
pm_summary_table
lrti_summary_table
save_summary

# Try child_age, gender, home_floors_2level, home_sqft_2level, residents_smoke
```


```{r, eval=FALSE, include=FALSE}
# Run and save model results 

er_income_results <- glmer(lrti_events_di_winter ~ pm_mean_sampling_period_iqr + child_age + 
                          residents_smoke + person_time_at_risk_winter + 
                          income_3level + 
                          (1 | home:cohort:area), 
                          data = analysis_data_winter1, family = binomial, nAGQ = 10)
write_rds(er_income_results, paste0(file_path, "Output/er_income_results.rds"))


er_filter_comp_results <- glmer(lrti_events_di_winter ~ pm_mean_sampling_period_iqr + child_age + 
                          income_3level + residents_smoke + person_time_at_risk_winter + 
                          kw_perc_exp_cat2 + 
                          (1 | home:cohort:area), 
                          data = analysis_data_winter1, family = binomial, nAGQ = 10)
write_rds(er_filter_comp_results, paste0(file_path, "Output/er_filter_comp_results.rds"))


er_burn_level_results <- glmer(lrti_events_di_winter ~ pm_mean_sampling_period_iqr + child_age + 
                          income_3level + residents_smoke + person_time_at_risk_winter + 
                          burn_level_3level + 
                          (1 | home:cohort:area), 
                          data = analysis_data_winter1, family = binomial, nAGQ = 10)
write_rds(er_burn_level_results, paste0(file_path, "Output/er_burn_level_results.rds"))


er_smoking_results <- glmer(lrti_events_di_winter ~ pm_mean_sampling_period_iqr + child_age + 
                          income_3level + person_time_at_risk_winter + 
                          home_act_smoking_sum + 
                          (1 | home:cohort:area), 
                          data = analysis_data_winter1, family = binomial, nAGQ = 10)
write_rds(er_smoking_results, paste0(file_path, "Output/er_smoking_results.rds"))


er_windows_results <- glmer(lrti_events_di_winter ~ pm_mean_sampling_period_iqr + child_age + 
                          income_3level + residents_smoke + person_time_at_risk_winter + 
                          home_act_windows_sum + 
                          (1 | home:cohort:area), 
                          data = analysis_data_winter1, family = binomial, nAGQ = 10)
write_rds(er_windows_results, paste0(file_path, "Output/er_windows_results.rds"))


er_door_results <- glmer(lrti_events_di_winter ~ pm_mean_sampling_period_iqr + child_age + 
                          income_3level + residents_smoke + person_time_at_risk_winter + 
                          home_act_door_sum + 
                          (1 | home:cohort:area), 
                          data = analysis_data_winter1, family = binomial, nAGQ = 10)
write_rds(er_door_results, paste0(file_path, "Output/er_door_results.rds"))


er_sweep_results <- glmer(lrti_events_di_winter ~ pm_mean_sampling_period_iqr + child_age + 
                          income_3level + residents_smoke + person_time_at_risk_winter +
                          home_act_sweep_sum + 
                          (1 | home:cohort:area), 
                          data = analysis_data_winter1, family = binomial, nAGQ = 10)
write_rds(er_sweep_results, paste0(file_path, "Output/er_sweep_results.rds"))


er_ambpm_results <- glmer(lrti_events_di_winter ~ pm_mean_sampling_period_iqr + child_age + 
                          income_3level + residents_smoke + person_time_at_risk_winter +
                          amb_pm_lrti + 
                          (1 | home:cohort:area), 
                          data = analysis_data_winter1, family = binomial, nAGQ = 10)
write_rds(er_ambpm_results, paste0(file_path, "Output/er_ambpm_results.rds"))


er_ambtemp_results <- glmer(lrti_events_di_winter ~ pm_mean_sampling_period_iqr + child_age + 
                          income_3level + residents_smoke + person_time_at_risk_winter +
                          amb_temp_lrti + 
                          (1 | home:cohort:area), 
                          data = analysis_data_winter1, family = binomial, nAGQ = 10)
write_rds(er_ambtemp_results, paste0(file_path, "Output/er_ambtemp_results.rds"))
```


```{r}
# Load results
er_results <- read_rds(paste0(file_path, "Output/er_results.rds"))
er_income_results <- read_rds(paste0(file_path, "Output/er_income_results.rds"))
#er_filter_comp_results <- read_rds(paste0(file_path, "Output/er_filter_comp_results.rds"))
er_burn_level_results <- read_rds(paste0(file_path, "Output/er_burn_level_results.rds"))
er_smoking_results <- read_rds(paste0(file_path, "Output/er_smoking_results.rds"))
er_windows_results <- read_rds(paste0(file_path, "Output/er_windows_results.rds"))
er_door_results <- read_rds(paste0(file_path, "Output/er_door_results.rds"))
er_sweep_results <- read_rds(paste0(file_path, "Output/er_sweep_results.rds"))
er_ambpm_results <- read_rds(paste0(file_path, "Output/er_ambpm_results.rds"))
er_ambtemp_results <- read_rds(paste0(file_path, "Output/er_ambtemp_results.rds"))


# Run function to clean results
results_function <- function(model_results, model_name) {
  
tidy_results <- tidy(model_results, conf.int = TRUE) %>% 
  mutate(group_filter = if_else(grepl("pm_mean", term), 1, 0)) %>% 
  filter(group_filter == 1) %>% 
  mutate(term = "PM2.5",
         model = model_name) %>% 
  mutate(estimate = round((exp(estimate)), digits = 2),
         conf.low = round((exp(conf.low)), digits = 2),
         conf.high = round((exp(conf.high)), digits = 2)) %>% 
  dplyr::select(model, term, estimate, conf.low, conf.high)
tidy_results

}


# Run results through function, save, combine for plotting
er_tidy <- results_function(er_results, "ER Primary")
er_income_tidy <- results_function(er_income_results, "ER + income")
#er_filter_comp_tidy <- results_function(er_filter_comp_results, "ER + filt comp")
er_burn_level_tidy <- results_function(er_burn_level_results, "ER + burn level")
er_smoking_tidy <- results_function(er_smoking_results, "ER + smoke act")
er_windows_tidy <- results_function(er_windows_results, "ER + window act")
er_door_tidy <- results_function(er_door_results, "ER + door act")
er_sweep_tidy <- results_function(er_sweep_results, "ER + sweep act")
er_ambpm_tidy <- results_function(er_ambpm_results, "ER + amb PM")
er_ambtemp_tidy <- results_function(er_ambtemp_results, "ER + amb temp")


# Combine cleaned results
er_results_combined <- rbind(er_tidy, er_income_tidy, er_burn_level_tidy, 
                              er_smoking_tidy, er_windows_tidy, er_door_tidy,
                              er_sweep_tidy, er_ambpm_tidy, er_ambtemp_tidy)


# Plot results
er_plot_estimates <- er_results_combined %>%
  mutate(model = factor(model,
                        levels = c("ER Primary", "ER + income", "ER + burn level",
                                   "ER + smoke act", "ER + window act", "ER + door act",
                                   "ER + sweep act", "ER + amb PM", "ER + amb temp"))) %>% 
  ggplot(aes(group = term, shape = term)) +
  geom_point(aes(x=model, y=estimate), 
             position = position_dodge(width = 0.5), size = 4) +
  geom_errorbar(aes(x=model, ymin=conf.low, ymax=conf.high), 
             position = position_dodge(width = 0.5), size = 1.2, width = 0.5) +
  geom_hline(yintercept = 1) +
  theme_bw() +  
  ggtitle(label = "Results for ER framework, LRTI outcome") +
  labs(y = "LRTI events per IQR \n increase in PM2.5") +
  labs(x = "", group = "", shape = "") +
  theme(title = element_text(size = 16), 
          axis.text.x = element_text(size = 16, colour = "black", angle = 45,
                                     hjust = 1, vjust = .8),
          axis.text.y = element_text(size = 16, colour = "black"),
          axis.title.y = element_text(size = 16,
                                      margin = margin(t = 0, r = 20, b = 0, l = 0)),
          axis.line.x = element_line(colour = "black", size = 1.2), 
          axis.line.y = element_line(colour = "black", size = 1.2), 
          axis.ticks = element_blank(), 
          panel.border = element_blank(), 
          panel.grid = element_blank(),
          legend.position = "none",
          legend.text = element_text(size = 14, colour = "black")) 
er_plot_estimates


# Save plot as jpg
#ggsave("er_plot_estimates.jpg", width = 12, height = 6)
```

ER Primary = Logistic regression mixed model, as specified above  
ER + income = Primary model using income instead of education  
ER + burn level = Primary model plus self-reported burn-level compared to typical  
ER + smoke act = Primary model plus # days during sampling with smoking  
ER + window act = Primary model plus # days during sampling with windows open  
ER + door act = Primary model plus # days during sampling with doors open  
ER + sweep act = Primary model plus # days during sampling with sweeping/cleaning  
ER + amb PM = Primary model plus amb PM during LRTI at-risk period  
ER + amb temp = Primary model plus amb temp during LRTI at-risk period  


```{r, eval=FALSE, include=FALSE}
################ Plot/check individual models and various results ##############

check_model_results <- glmer(lrti_events_di_total ~ treatment_assigned + 
                     child_age + person_time_at_risk + moisture_closest + 
                     (1 | home:cohort:area),
                     data = analysis_data, family = binomial, nAGQ = 20)

summary(check_model_results)


# Run function to clean results
results_function <- function(model_results) {
  
tidy_results <- tidy(model_results, conf.int = TRUE) %>% 
  #mutate(group_filter = if_else(grepl("pm_mean", term), 1, 0)) %>% 
  mutate(group_filter = if_else(grepl("treatment", term), 1, 0)) %>% 
  filter(group_filter == 1) %>% 
  dplyr::select(term, estimate, conf.low, conf.high)
tidy_results

}


# Run results through function, save, combine for plotting
results_tidy <- results_function(check_model_results)


# Plot results
plot_estimates <- results_tidy %>%
  #filter(term != "treatment_filter_typeHoneywell") %>% 
  ggplot(aes(group = term, shape = term)) +
  geom_point(aes(x=1, y=estimate), 
             position = position_dodge(width = 0.5), size = 4) +
  geom_errorbar(aes(x=1, ymin=conf.low, ymax=conf.high), 
             position = position_dodge(width = 0.5), size = 1.2, width = 0.5) +
  geom_hline(yintercept = 0) +
  theme_bw() +  
  labs(y = "Results compared to placebo") +
  labs(x = "", group = "", shape = "") +
  theme(title = element_text(size = 16), 
          axis.text.x = element_text(size = 16, colour = "black", angle = 45,
                                     hjust = 1, vjust = .8),
          axis.text.y = element_text(size = 16, colour = "black"),
          axis.title.y = element_text(size = 16,
                                      margin = margin(t = 0, r = 20, b = 0, l = 0)),
          axis.line.x = element_line(colour = "black", size = 1.2), 
          axis.line.y = element_line(colour = "black", size = 1.2), 
          axis.ticks = element_blank(), 
          panel.border = element_blank(), 
          panel.grid = element_blank(),
          legend.position = "right",
          legend.text = element_text(size = 14, colour = "black")) 
plot_estimates


# Check summary data
grouped_data <- analysis_data %>% 
  group_by(treatment_assigned) %>% 
  summarize(min(moisture_closest, na.rm = TRUE),
            median(moisture_closest, na.rm = TRUE),
            max(moisture_closest, na.rm = TRUE),
            mean(moisture_closest, na.rm = TRUE),
            sd(moisture_closest, na.rm = TRUE))
grouped_data
#table(analysis_data$moisture_closest)
#summary(analysis_data$moisture_closest)
anova_model <- lm(moisture_closest ~ treatment_assigned, data = analysis_data)
anova(anova_model)


# Check model observation numbers
table(model.frame(itt_results_int)$treatment_assigned)
nobs(itt_results_int)


# backtransform model results for log(pm) models
((exp(-.374)-1)*100)


# Check PM concentrations for subgroups
pm_summary_table <- analysis_data_winter1 %>% 
  filter(!is.na(lrti_events_di_winter) & !is.na(pm_mean_sampling_period) &
           !is.na(child_age) & !is.na(education_3level) & !is.na(residents_smoke)) %>% 
  #group_by(treatment_assigned) %>% 
  summarize("Mean PM" = mean(pm_mean_sampling_period, na.rm = TRUE),
            "n" = n(),
            "SD PM" = sd(pm_mean_sampling_period, na.rm = TRUE),
            "Min PM" = min(pm_mean_sampling_period, na.rm = TRUE),
            "Median PM" = median(pm_mean_sampling_period, na.rm = TRUE),
            "Max PM" = max(pm_mean_sampling_period, na.rm = TRUE))
pm_summary_table


pm_summary_table <- analysis_data_winter1 %>% 
  filter(!is.na(pm_mean_sampling_period)) %>% 
  group_by(treatment_filter_type) %>% 
  summarize("Mean PM" = mean(pm_mean_sampling_period, na.rm = TRUE),
            "n" = n(),
            "SD PM" = sd(pm_mean_sampling_period, na.rm = TRUE),
            "Min PM" = min(pm_mean_sampling_period, na.rm = TRUE),
            "Median PM" = median(pm_mean_sampling_period, na.rm = TRUE),
            "Max PM" = max(pm_mean_sampling_period, na.rm = TRUE))
pm_summary_table


lrti_summary_table <- analysis_data_winter1 %>% 
  filter(!is.na(lrti_events_di_winter) & !is.na(pm_mean_sampling_period) &
           !is.na(child_age) & !is.na(education_3level) & !is.na(residents_smoke)) %>% 
  #group_by(treatment_assigned) %>% 
  mutate(lrti_events_num = as.numeric(lrti_events_di_winter),
         lrti_events_num = lrti_events_num - 1) %>%  
  summarize("Total LRTI" = sum(lrti_events_num, na.rm = TRUE),
            "Group %" = `Total LRTI`/n()*100)
lrti_summary_table


lrti_summary_table <- analysis_data_winter1 %>% 
  filter(!is.na(pm_mean_sampling_period)) %>% 
  mutate(lrti_events_num = as.numeric(lrti_events_di_winter),
         lrti_events_num = lrti_events_num - 1) %>% 
  group_by(treatment_filter_type) %>% 
  summarize("Total LRTI" = sum(lrti_events_num, na.rm = TRUE),
            "Group %" = `Total LRTI`/n()*100)
lrti_summary_table
```



```{r, eval=FALSE, include=FALSE}
# ER framework using a Spline for PM

spline_data <- analysis_data_winter1 %>% 
  filter(pm_mean_sampling_period < 200) %>% 
  mutate(pm_cat = cut(pm_mean_sampling_period,
                      breaks = c(0, 10, 20, 35, 300),
                      labels = c("0 to 10", "10 to 20",
                                 "20 to 35", "35+")))
  


# s() is the command for a spline
# fx=TRUE makes a fixed df regression spline, as opposed to a penalized spline
# bs = "cr" makes this a cubic regression spline
## Default is "tp" for thin plate regression spline
## Both seem to have the same effect on the model
# k = 6 sets the degrees of freedom (df = k-1)

library(splines)
library(gamm4)

model_pm_spline <- gamm4(lrti_events_di_winter ~ s(pm_mean_sampling_period, 
                          fx = TRUE, bs = "tp", k = 5) + 
                          child_age +  education_3level + residents_smoke +
                          person_time_at_risk_winter, 
                          data = spline_data, family = binomial(link = "logit"), 
                          random = ~(1 | cohort:area))
plot(model_pm_spline$gam, seWithMean = TRUE, select = 1, shade = TRUE,
     xlab = expression(paste("Area PM"[2.5], 
                             " (", mu, g/m^3, ")")),
     ylab = expression(paste("OR, spline trend for area PM  "[2.5])))
summary(model_pm_spline$gam)
summary(model_pm_spline$mer)



# Try using PM grouped by quartiles

er_results <- glmer(lrti_events_di_winter ~ pm_cat + child_age + 
                          education_3level + residents_smoke + person_time_at_risk_winter +
                          (1 | cohort:area), 
                          data = spline_data, family = binomial, nAGQ = 10,
                          control = glmerControl(optimizer = "bobyqa"))
summary(er_results)
```

